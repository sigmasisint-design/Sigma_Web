<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA - Gestão Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // *** VARIÁVEIS DE AMBIENTE - AJUSTE AQUI ***
        const SUPABASE_URL = 'SUA_URL_DO_SUPABASE'; // Ex: 'https://xyz1234.supabase.co'
        const SUPABASE_ANON_KEY = 'SUA_CHAVE_ANON_DO_SUPABASE'; // Ex: 'eyJhbGciOiJIUzI1NiI...'
        const TABLE_NAME = 'perfis'; // Nome da sua tabela de perfis de usuário

        // Inicializa o cliente Supabase principal
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // *****************************************
        
        let perfilUsuario = null; // Armazena os dados do perfil do usuário logado
    </script>

    <style>
        /* CSS BÁSICO PARA O LAYOUT (Baseado nas classes usadas) */
        body { font-family: 'Arial', sans-serif; background-color: #f4f7f6; }
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; }
        .subtitulo { color: #6c757d; margin-bottom: 20px; font-size: 0.9em; text-align: center; }
        .login-card h4 { text-align: center; color: #007bff; font-weight: 700; }
        
        /* Layout Principal (Main Wrapper) */
        .main-wrapper { display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background-color: #2c3e50; color: white; transition: width 0.3s; display: flex; flex-direction: column; }
        .sidebar.collapsed { width: 60px; }
        .sidebar .menu-items { flex-grow: 1; padding-top: 20px; }
        .sidebar a { display: flex; align-items: center; padding: 10px 15px; text-decoration: none; color: white; transition: background-color 0.2s; }
        .sidebar a:hover { background-color: #34495e; }
        .sidebar .icon { margin-right: 15px; font-size: 24px; }
        .sidebar.collapsed .text, .sidebar.collapsed .user-profile, .sidebar.collapsed .expand-icon { display: none; }
        .sidebar.collapsed .icon { margin-right: 0; }
        .sidebar .user-profile { padding: 10px 15px; text-align: center; border-bottom: 1px solid #4a627a; }
        .sidebar .user-name { font-weight: bold; }
        
        /* Submenu */
        .submenu a { padding-left: 45px; background-color: #3f5872; }
        
        /* Logout Area */
        .logout-area { border-top: 1px solid #4a627a; padding: 10px 0; }
        
        /* Content Wrapper */
        .content-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .topbar { background-color: #ffffff; padding: 15px 25px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); font-size: 1.2em; font-weight: 600; color: #333; }
        .content { padding: 25px; flex-grow: 1; }
        .footer { background-color: #ecf0f1; padding: 10px 25px; font-size: 0.8em; color: #7f8c8d; display: flex; justify-content: space-between; }
        
        /* Overlay para bloqueio de tela */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center; color: white; font-size: 1.5em; }
    </style>
</head>
<body>

    <div id="main-container">
        </div>
    
    <div id="loading-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span style="margin-left: 10px;">Carregando...</span>
    </div>

    <script>
        // Elementos globais
        const mainContainer = document.getElementById('main-container');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Funções utilitárias (Mocks para funções de tela)
        function blockScreen() { loadingOverlay.style.display = 'flex'; }
        function unblockScreen() { loadingOverlay.style.display = 'none'; }
        // Função simples para gerar um UUID fictício
        function generateUUID() { 
            return 'xxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { 
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); 
                return v.toString(16); 
            }); 
        }


        // --- FUNÇÕES DE LOGIN E SEGURANÇA ---

        async function handleLogin() {
            const email = document.getElementById('idUsu').value;
            const password = document.getElementById('senhaUsu').value;
            const feedback = document.getElementById('login-feedback');
            
            if(!email || !password){ Swal.fire("Atenção","Preencha E-mail e Senha","warning"); return; }
            
            blockScreen();
            feedback.style.display = 'none';

            // 1. Tenta autenticar via Supabase Auth
            const { data: authData, error: loginError } = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
            
            if (loginError) {
                unblockScreen();
                feedback.textContent = "Credenciais inválidas. Verifique seu e-mail e senha.";
                feedback.style.display = 'block';
                return;
            }
            
            const userId = authData.user.id;
            const accessToken = authData.session.access_token;
            
            let userSessionId = authData.session.id;
            if (!userSessionId) {
                userSessionId = generateUUID();
                console.warn("⚠️ Não foi possível obter o ID da sessão do Supabase. Usando UUID Fictício:", userSessionId);
            }

            // 2. Cria um cliente autenticado para buscar o perfil (usa o token para respeitar RLS)
            const authenticatedClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                global: { headers: { Authorization: `Bearer ${accessToken}` } }
            });

            // 3. Busca o perfil na tabela 'perfis'
            const { data: perfil, error: perfilError } = await authenticatedClient
                .from(TABLE_NAME).select(`id, bloqueado, cont_erro_login, primeiro_acesso, nome_usu, nivel_usu, sessao_atual`).eq('id', userId).single();
            
            if (perfilError || !perfil) {
                await supabaseClient.auth.signOut();
                unblockScreen();
                Swal.fire("Erro de Sistema", "Perfil de usuário não encontrado. Contate o suporte.", "error");
                return;
            }
            
            if (perfil.bloqueado) {
                await supabaseClient.auth.signOut();
                unblockScreen();
                feedback.textContent = `Acesso bloqueado. Contate o administrador.`;
                feedback.style.display = 'block';
                return;
            }
            
            if (perfil.primeiro_acesso) {
                unblockScreen();
                await supabaseClient.auth.setSession(authData.session);
                perfilUsuario = perfil;
                showChangePasswordForm(perfil);
                return;
            }
            
            // 4. LÓGICA DE SESSÃO ÚNICA
            if (perfil.sessao_atual && perfil.sessao_atual !== userSessionId) {
                unblockScreen();
                Swal.fire({
                    title: "⚠️ Aviso de Sessão Ativa",
                    html: `<p>Detectamos outra sessão ativa (ID: ${perfil.sessao_atual.substring(0, 8)}). Deseja continuar e desconectar a outra sessão?</p>`,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Sim, Continuar",
                    cancelButtonText: "Não, Cancelar"
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        blockScreen();
                        // 5. Atualiza o perfil forçando a nova sessão
                        const { error: sessionUpdateError } = await authenticatedClient.from(TABLE_NAME).update({
                            sessao_atual: userSessionId,
                            cont_erro_login: 0
                        }).eq('id', perfil.id);
                        
                        if (sessionUpdateError) {
                            await supabaseClient.auth.signOut();
                            unblockScreen();
                            Swal.fire("Erro de Permissão (RLS)", `Falha ao registrar a sessão: ${sessionUpdateError.message}. Verifique a RLS.`, "error");
                            return;
                        }

                        await supabaseClient.auth.setSession(authData.session);
                        perfilUsuario = perfil;
                        perfilUsuario.sessao_atual = userSessionId;
                        unblockScreen();
                        renderMainPage(perfilUsuario);

                    } else {
                        await supabaseClient.auth.signOut();
                        renderLogin();
                    }
                });
                return;
            }
            
            // 6. REGISTRA A NOVA SESSÃO SE NÃO HOUVER CONFLITO
            const { error: sessionUpdateError } = await authenticatedClient
                .from(TABLE_NAME)
                .update({
                    cont_erro_login: 0,
                    sessao_atual: userSessionId
                })
                .eq('id', perfil.id);
            
            if (sessionUpdateError) {
                await supabaseClient.auth.signOut();
                unblockScreen();
                Swal.fire("Erro de Permissão (RLS)", `Falha ao registrar a sessão: ${sessionUpdateError.message}. Verifique a RLS.`, "error");
                return;
            }

            await supabaseClient.auth.setSession(authData.session);

            perfilUsuario = perfil;
            perfilUsuario.sessao_atual = userSessionId;

            unblockScreen();
            renderMainPage(perfilUsuario);
        }

        // Função de Logout com confirmação
        async function handleLogout(showPopup = true) {
            
            if (showPopup) {
                const result = await Swal.fire({
                    title: "Deseja realmente sair?",
                    text: "Sua sessão será encerrada. Você precisará fazer login novamente.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sim, Sair',
                    cancelButtonText: 'Cancelar'
                });

                if (!result.isConfirmed) {
                    return; 
                }
            }
            
            blockScreen();
            if (perfilUsuario) {
                // Remove a sessão do banco de dados (null no campo sessao_atual)
                await supabaseClient.from(TABLE_NAME).update({ sessao_atual: null }).eq('id', perfilUsuario.id);
            }
            
            await supabaseClient.auth.signOut();
            perfilUsuario = null;

            unblockScreen();
            
            if (showPopup) {
                Swal.fire({ title: "Logout", text: "Sessão encerrada com sucesso.", icon: "info", allowOutsideClick: false, confirmButtonText: "OK" }).then(() => { renderLogin(); });
            } else {
                renderLogin();
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById("idUsu").value.trim();
            if (!email) { Swal.fire("Atenção", "Preencha o E-mail para solicitar a nova senha", "warning"); return; }
            blockScreen();
            // Redireciona para a página atual após o reset
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + window.location.pathname });
            unblockScreen();
            if (error) { Swal.fire('Erro ao solicitar reset', error.message, 'error'); } else { Swal.fire('Sucesso', 'Instruções para reset de senha enviadas para o seu e-mail.', 'success'); }
        }

        function validarForcaSenha(senha){
            if(senha.length < 8) return "A senha deve ter no mínimo 8 caracteres";
            if(!/[A-Z]/.test(senha)) return "A senha deve conter pelo menos uma letra maiúscula";
            if(!/[!@#$%^&*(),.?":{}|<>]/.test(senha)) return "A senha deve conter pelo menos um caractere especial";
            return null;
        }

        // Salva a nova senha no primeiro acesso (Troca de senha obrigatória)
        async function salvarNovaSenha() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confSenha = document.getElementById('confSenha').value;

            if(!novaSenha || novaSenha!==confSenha){ Swal.fire('Erro','As senhas não conferem','error'); return; }
            const msgErro = validarForcaSenha(novaSenha);
            if(msgErro){ Swal.fire('Erro', msgErro, 'error'); return; }

            blockScreen();

            const { error: authError } = await supabaseClient.auth.updateUser({ password: novaSenha });
            if (authError) { unblockScreen(); Swal.fire('Erro','Falha ao atualizar senha no Auth: ' + authError.message,'error'); return; }

            // Marca 'primeiro_acesso' como false no perfil
            const { error: perfilError } = await supabaseClient.from(TABLE_NAME).update({ primeiro_acesso: false }).eq('id', perfilUsuario.id);
            unblockScreen();
            
            if (perfilError) {
                Swal.fire('Atenção', 'Senha atualizada, mas falha ao marcar o primeiro acesso no perfil.','warning').then(() => { handleLogout(true); });
            } else {
                await Swal.fire('Sucesso','Senha atualizada! Faça login com a nova senha.','success');
                handleLogout(false);
            }
        }

        // Lógica de atualização de senha após o link de recuperação (com token)
        async function handlePasswordUpdate() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confSenha = document.getElementById('confSenha').value;
            const btnSalvar = document.getElementById('btnSalvarSenha');

            if(!novaSenha || novaSenha!==confSenha){ Swal.fire('Erro','As senhas não conferem','error'); return; }
            const msgErro = validarForcaSenha(novaSenha);
            if(msgErro){ Swal.fire('Erro', msgErro, 'error'); return; }

            blockScreen();
            btnSalvar.disabled = true;

            const { error } = await supabaseClient.auth.updateUser({ password: novaSenha });
            
            unblockScreen();
            btnSalvar.disabled = false;

            if (error) {
                Swal.fire('Erro ao Atualizar', 'Falha ao atualizar a senha: ' + error.message, 'error');
            } else {
                await Swal.fire('Sucesso!', 'Sua senha foi atualizada. Faça login.', 'success');
                
                window.history.replaceState({}, document.title, window.location.pathname);
                renderLogin();
            }
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO DE TELA ---

        function renderLogin() {
            mainContainer.innerHTML = `
                <div class="login-container" id="login-container">
                    <div class="login-card">
                        <h4>SIGMA</h4>
                        <div class="subtitulo">Gestão Inteligente</div>
                        
                        <div class="mb-3 mt-3">
                            <label for="idUsu" class="form-label">E-mail:</label>
                            <input type="email" id="idUsu" class="form-control" placeholder="Digite seu E-mail" required>
                        </div>

                        <div class="mb-3" id="senhaUsuContainer">
                            <label for="senhaUsu" class="form-label">Senha:</label>
                            <input type="password" id="senhaUsu" class="form-control" placeholder="Digite sua senha" required>
                        </div>

                        <div class="mb-3" id="novaSenhaDiv" style="display:none;">
                            <label for="novaSenha" class="form-label">Nova Senha:</label>
                            <input type="password" id="novaSenha" class="form-control" placeholder="Mínimo 8 caracteres, com maiúscula e especial">
                        </div>

                        <div class="mb-3" id="confSenhaDiv" style="display:none;">
                            <label for="confSenha" class="form-label">Confirme a Senha:</label>
                            <input type="password" id="confSenha" class="form-control" placeholder="Confirme a nova senha">
                        </div>
                        <button class="btn btn-primary w-100" id="btnLogin" onclick="handleLogin()">Entrar</button>
                        <button class="btn btn-success w-100" id="btnSalvarSenha" style="display:none;" onclick="salvarNovaSenha()">Salvar Senha</button>

                        <p id="login-feedback" class="text-danger text-center mt-2" style="display:none;"></p>

                        <div class="text-center mt-2">
                            <a href="javascript:void(0);" id="linkEsqueciSenha" onclick="handlePasswordReset()">Esqueci minha senha</a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Função para alterar senha no primeiro acesso
        function showChangePasswordForm(perfil) {
            document.getElementById('senhaUsuContainer').style.display='none';
            document.getElementById('novaSenhaDiv').style.display='block';
            document.getElementById('confSenhaDiv').style.display='block';
            document.getElementById('btnSalvarSenha').style.display='block';
            document.getElementById('btnLogin').style.display='none';
            document.getElementById('linkEsqueciSenha').style.display='none';
            document.getElementById('login-feedback').textContent = `Defina uma nova senha.`;
            document.getElementById('login-feedback').style.display = 'block';
            document.getElementById('btnSalvarSenha').onclick = salvarNovaSenha; 
            document.getElementById('idUsu').disabled = true; 
        }

        // Função para renderizar formulário de alteração de senha após clique no e-mail (Token)
        function renderChangePasswordForm(message = "Defina sua nova senha.", emailParaPreencher = "") {
            renderLogin(); 
            document.getElementById('senhaUsuContainer').style.display='none';
            document.getElementById('novaSenhaDiv').style.display='block';
            document.getElementById('confSenhaDiv').style.display='block';
            
            const emailInput = document.getElementById('idUsu');
            emailInput.value = emailParaPreencher;
            emailInput.disabled = true; 

            document.getElementById('btnLogin').style.display='none';
            const btnSalvar = document.getElementById('btnSalvarSenha');
            btnSalvar.style.display='block';
            btnSalvar.onclick = handlePasswordUpdate; 

            document.getElementById('linkEsqueciSenha').style.display='none';
            document.getElementById('login-feedback').textContent = message;
            document.getElementById('login-feedback').style.display = 'block';
            document.getElementById('login-feedback').classList.remove('text-danger');
            document.getElementById('login-feedback').classList.add('text-success');
        }

        function toggleSidebar(){
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                document.querySelectorAll('.submenu').forEach(sm => sm.style.display = "none");
            }
        }

        function handleMenuClick(submenuId) {
            const sidebar = document.getElementById('sidebar');
            const submenu = document.getElementById(submenuId);

            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                submenu.style.display = "block";
            } else {
                submenu.style.display = (submenu.style.display === "none") ? "block" : "none";
            }
        }

        // Função de carregamento de página simplificada
        async function loadPage(pageName) {
            const content = document.getElementById('page-content');
            const topbarTitle = document.getElementById('topbar-title');
            
            if (topbarTitle) { topbarTitle.innerHTML = `${pageName}`; }

            blockScreen();

            if (pageName === 'Dashboard') {
                content.innerHTML = `<h3>Dashboard</h3><div class="alert alert-info">Bem-vindo(a), **${perfilUsuario.nome_usu}**! Clique nos links do menu lateral para navegar!</div>`;
            } else {
                content.innerHTML = `<h3>${pageName}</h3><div class="alert alert-warning">Este módulo está em desenvolvimento.</div>`;
            }

            unblockScreen();
        }

        function renderMainPage(perfil) {
            const sessaoIdCurto = perfil.sessao_atual ? perfil.sessao_atual.substring(0, 8) : 'N/A';
            
            mainContainer.innerHTML = `
                <div class="main-wrapper" id="main-wrapper">
                    <div class="sidebar collapsed" id="sidebar">
                        <div class="menu-items">
                            <a href="javascript:void(0);" class="toggle-btn" onclick="toggleSidebar()">
                                <span class="icon">menu</span>
                                <span class="text">SIGMA</span>
                            </a>
                            <hr>

                            <div class="user-profile" id="user-profile-info">
                                <div class="user-greeting">Bem-vindo(a),</div>
                                <div class="user-name">${perfil.nome_usu || 'Usuário'}</div>
                            </div>
                            <hr>

                            <a href="#" onclick="loadPage('Dashboard')"><span class="icon">home</span><span class="text">Dashboard</span></a>

                            <div class="menu-item">
                                <a href="#" onclick="handleMenuClick('cadastrosSub')">
                                    <span class="icon">engineering</span>
                                    <span class="text">Cadastros</span>
                                    <span class="icon expand-icon" style="margin-left:auto;">expand_more</span>
                                </a>
                                <div class="submenu" id="cadastrosSub" style="display:none;">
                                    <a href="#" onclick="loadPage('Obras')"><span class="icon">format_list_bulleted</span><span class="text">Obras</span></a>
                                    <a href="#" onclick="loadPage('Departamentos')"><span class="icon">groups</span><span class="text">Departamentos</span></a>
                                </div>
                            </div>
                            
                            <a href="#" onclick="loadPage('Relatórios')"><span class="icon">bar_chart</span><span class="text">Relatórios</span></a>
                        </div>

                        <div class="logout-area">
                            <a href="#" onclick="handleLogout()">
                            <span class="icon">logout</span><span class="text">Sair</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="content-wrapper">
                        <div class="topbar" id="topbar-title">Menu Principal</div>
                        <div class="content" id="page-content">
                        </div>
                        <div class="footer">
                            <span>SIGMA - Sistema Inteligente de Gestão &copy; 2025</span>
                            <span id="nivel-usuario">Perfil: ${perfil.nivel_usu || 'Padrão'} | Sessão ID: ${sessaoIdCurto}</span>
                        </div>
                    </div>
                </div>
            `;
            loadPage('Dashboard');
        }

        // --- LÓGICA DE INICIALIZAÇÃO E CHECAGEM DE URL ---

        async function checkURLForPasswordReset() {
            const hash = window.location.hash;
            const urlParams = new URLSearchParams(hash.substring(1));
            const type = urlParams.get('type');
            const accessToken = urlParams.get('access_token');
            
            if (type === 'recovery' && accessToken) {
                blockScreen();
                
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError || !session) {
                    unblockScreen();
                    window.history.replaceState({}, document.title, window.location.pathname);
                    Swal.fire('Erro de Token', 'O link de recuperação expirou ou é inválido.', 'error');
                    renderLogin();
                    return true; 
                }
                
                const userEmail = session.user.email;

                unblockScreen();
                
                renderChangePasswordForm("Defina uma nova senha.", userEmail);
                return true; 
            }
            return false; 
        }

        async function initApp() {
            blockScreen();
            
            // 1. Prioridade: Redefinição de Senha
            const isResetFlow = await checkURLForPasswordReset();
            if (isResetFlow) {
                unblockScreen();
                return;
            }

            // 2. Segunda Prioridade: Sessão Ativa
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                const userId = session.user.id;
                const { data: perfil, error: perfilError } = await supabaseClient
                    .from(TABLE_NAME)
                    .select(`id, nome_usu, nivel_usu, sessao_atual`)
                    .eq('id', userId)
                    .single();

                if (perfil && !perfilError) {
                    perfilUsuario = perfil;
                    renderMainPage(perfilUsuario);
                    unblockScreen();
                    return;
                } else {
                    await supabaseClient.auth.signOut();
                }
            } else {
                await supabaseClient.auth.signOut();
            }
            
            // 3. Padrão: Tela de Login
            renderLogin();
            unblockScreen();
        }

        // INICIA O APLICATIVO
        initApp();
    </script>
</body>
</html>
