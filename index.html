<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%231565C0%22><path d=%22M11 20v-5h-4l6-11v5h4l-6 11z%22/><text x=%2222%22 y=%2220%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%231565C0%22>Σ</text></svg>">
    <title>SIGMA - Gestão Inteligente</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        /* ==================== CSS BÁSICO E LOGIN ==================== */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            font-size: 0.95rem;
            color: #1565C0; 
            background: #f5f6fa;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .login-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-card h4 { text-align: center; margin: 0; line-height: 1; color: #1565C0; font-size: 2.2rem; }
        .login-card .subtitulo { font-size: 0.85rem; text-align: center; color: #1565C0; margin: 0; line-height: 1; }
        
        .login-card .form-label { margin-bottom: 2px; color: #1565C0; }
        .login-card .form-control { border-radius: 5px; color: #333; }
        .login-card .form-control::placeholder { color: rgba(0, 0, 0, 0.6); opacity: 1; }
        .login-card .btn-primary, .btn-success{background: #1565C0; border-color: #1565C0;}
        .login-card .btn-primary:hover, .btn-success:hover { background: #1255a5; border-color: #1255a5;}
        
        /* CSS para o overlay de bloqueio */
        #screen-blocker {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.5);
            z-index: 9999;
            cursor: progress;
        }
        
        /* ==================== CSS PARA O DASHBOARD ==================== */
        .main-wrapper { display: flex; height: 100vh; overflow: hidden; }
        .sidebar {
            width: 220px;
            background-color: #1565C0; 
            color: #fff; 
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
            overflow: hidden;
            flex-shrink: 0;
        }
        .sidebar.collapsed { width: 40px; }
        
        /* ---------------------------------------------------- */
        .user-profile {
            padding: 10px 10px 8px 10px; 
            color: rgba(255, 255, 255, 0.85);
            transition: opacity 0.3s;
            overflow: hidden; 
            white-space: nowrap; 
        }

        .user-profile .user-greeting {
            font-size: 0.75rem; 
            margin-bottom: 0px;
        }

        .user-profile .user-name {
            font-size: 0.95rem; 
            font-weight: bold;
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        .sidebar.collapsed .user-profile {
            display: none; 
        }
        /* ---------------------------------------------------- */

        .logout-area { margin-top: auto; }
        .sidebar .menu-items { display: flex; flex-direction: column; margin-top: 0; }
        
        .sidebar hr { border-top: 1px solid #ffffff33; margin: 5px 0; }
        
        /* ESTILOS DE LINK GERAL */
        .sidebar a {
            color: #fff;
            text-decoration: none;
            padding: 8px 10px; 
            display: flex;
            align-items: center;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        .sidebar a:hover { background-color: #1255a5; }
        
        .sidebar .icon {
            font-family: 'Material Symbols Outlined';
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 20px;
            margin-left: 5px;
            margin-right: 10px; 
            display: inline-block;
            text-align: center;
        }

        /* Sidebar recolhida */
        .sidebar.collapsed a { justify-content: center; padding: 8px 0; }
        .sidebar.collapsed a .icon { margin: 0; width: 100%; display: block; text-align: center; }

        .sidebar.collapsed a .text,
        .sidebar.collapsed .user-info { display: none; }
        .sidebar.collapsed a .expand-icon { display: none; }

        /* Submenu Container (Mesma cor do menu principal) */
        .submenu { 
            background-color: #1565C0; /* Cor do Menu Principal */
            padding-bottom: 5px; 
        }
        
        .submenu a { 
            padding-left: 35px; 
            font-size: 0.9rem; 
            padding-top: 6px; 
            padding-bottom: 6px; 
        }
        
        .submenu a:hover {
            background-color: #1255a5; 
        }
        
        /* AJUSTE DO BOTÃO SAIR */
        .logout-area a { padding: 5px 10px; background-color: #dc3545 !important; }
        .sidebar.collapsed .logout-area a { padding: 5px 0; }

        .content-wrapper { flex: 1; display: flex; flex-direction: column; }
        .topbar { 
            background-color: #e9ecef; 
            display: flex; 
            align-items: center; 
            padding: 10px 15px; 
            font-weight: bold; 
            border-bottom: 1px solid #dee2e6;
            color: #1565C0; 
            font-size: 1.1rem; 
        }
        .content { 
            flex: 1; 
            padding: 20px; 
            background: #f5f6fa; 
            overflow-y: auto; 
            color: #333; 
        }
        .content h3 { color: #1565C0; }

        .footer { 
            height: 40px; 
            background-color: #e9ecef; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 15px; 
            font-size: 0.85rem; 
            color: #6c757d; 
            border-top: 1px solid #dee2e6;
        }
        
        .login-card #linkEsqueciSenha { color: #1565C0; text-decoration: none; }
        .login-card #linkEsqueciSenha:hover { text-decoration: underline; }
        .login-card #login-feedback { color: #dc3545 !important; }
        
        /* Estilos do CRUD */
        .table-responsive {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
        }
        .table-crud th, .table-crud td {
            font-size: 0.85rem;
            vertical-align: middle;
            white-space: nowrap; 
            color: #333; 
        }
        .table-crud .btn-sm {
            padding: 2px 5px;
            font-size: 0.75rem;
        }
        .btn-acao {
            padding: 4px 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="main-container"></div>
    <div id="screen-blocker"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // =======================================================
        // CONSTANTES E INICIALIZAÇÃO DO SUPABASE
        // =======================================================
        const SUPABASE_URL = 'https://nxgccbvfcxbukhciknoo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54Z2NjYnZmY3hidWtoY2lrbm9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyODkzMDAsImV4cCI6MjA3Mzg2NTMwMH0.8iTGv8HzocnJBXB9xT5VUNbwidceKIIbZDuwhGKnahk';
        const TABLE_NAME = 'perfis';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let perfilUsuario = null; 
        let sessaoIDAtual = null; 
        let currentEditingUser = null; 

        const mainContainer = document.getElementById("main-container");
        const screenBlocker = document.getElementById('screen-blocker');

        // =======================================================
        // FUNÇÕES UTILITÁRIAS
        // =======================================================
        function blockScreen() { screenBlocker.style.display='block'; }
        function unblockScreen() { screenBlocker.style.display='none'; }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function resetForm(clearOnly = false) {
            const form = document.getElementById('formCadastroUsuario');
            if (!form) return;
            
            form.reset();
            currentEditingUser = null;
            document.getElementById('cadUserId').value = "";
            document.getElementById('form-title').textContent = "Novo Usuário";
            document.getElementById('cadastro-feedback').style.display = 'none';

            const senhaField = document.getElementById('senha-field');
            if (senhaField) senhaField.style.display = 'block';
            document.getElementById('cadSenha').required = true;
            document.getElementById('cadSenha').placeholder = "Mínimo 8 caracteres";
            
            document.getElementById('cadEmail').disabled = false;
            document.getElementById('cadEmail').placeholder = "Será usado para login";
            document.getElementById('cadEmail').required = true;
            
            document.getElementById('btnSalvarUsuario').innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px; margin-right: 5px; vertical-align: middle;">person_add</span> Cadastrar Usuário';
            document.getElementById('btnLimparForm').style.display = 'none';
            
            if (clearOnly) {
                Swal.fire('Novo Cadastro', 'Formulário pronto para um novo usuário.', 'info');
            }
        }
        
        function initializeCrudListeners() {
            const formCadastro = document.getElementById('formCadastroUsuario');
            if (formCadastro) {
                formCadastro.removeEventListener('submit', handleCadastroUsuario); 
                formCadastro.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleCadastroUsuario();
                });
            }
            
            const cadCpfInput = document.getElementById('cadCPF');
            if (cadCpfInput) {
                cadCpfInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
            
            const btnLimpar = document.getElementById('btnLimparForm');
            if (btnLimpar) {
                btnLimpar.addEventListener('click', function() {
                    resetForm(true);
                });
            }
        }

        // =======================================================
        // FUNÇÕES DE INTERFACE (LOGIN/DASHBOARD)
        // =======================================================
        
        function renderLogin() {
            mainContainer.innerHTML = `
                <div class="login-container" id="login-container">
                    <div class="login-card">
                        <h4>SIGMA</h4>
                        <div class="subtitulo">Gestão Inteligente</div>
                        
                        <div class="mb-3 mt-3" id="emailDiv">
                            <label for="idUsu" class="form-label">E-mail:</label>
                            <input type="email" id="idUsu" class="form-control" placeholder="Digite seu E-mail" required>
                        </div>

                        <div class="mb-3" id="senhaDiv">
                            <label for="senhaUsu" class="form-label">Senha:</label>
                            <input type="password" id="senhaUsu" class="form-control" placeholder="Digite sua senha" required>
                        </div>

                        <div class="mb-3" id="novaSenhaDiv" style="display:none;">
                            <label for="novaSenha" class="form-label">Nova Senha:</label>
                            <input type="password" id="novaSenha" class="form-control" placeholder="Digite a nova senha">
                        </div>

                        <div class="mb-3" id="confSenhaDiv" style="display:none;">
                            <label for="confSenha" class="form-label">Confirme a Senha:</label>
                            <input type="password" id="confSenha" class="form-control" placeholder="Confirme a nova senha">
                        </div>

                        <button class="btn btn-primary w-100" id="btnLogin" onclick="handleLogin()">Entrar</button>
                        <button class="btn btn-success w-100" id="btnSalvarSenha" style="display:none;">Salvar Senha</button>

                        <p id="login-feedback" class="text-danger text-center mt-2" style="display:none;"></p>

                        <div class="text-center mt-2">
                            <a href="javascript:void(0);" id="linkEsqueciSenha" onclick="handlePasswordReset()">Esqueci minha senha</a>
                        </div>
                    </div>
                </div>
            `;
            
            // Garante que o botão de salvar senha tenha o listener correto para o fluxo de Login/Primeiro Acesso
            const btnSalvar = document.getElementById('btnSalvarSenha');
            if (btnSalvar) {
                 btnSalvar.onclick = salvarNovaSenha; 
            }
        }
        
        function toggleSidebar(){ 
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                document.querySelectorAll('.submenu').forEach(sm => sm.style.display = "none");
            }
        }

        function handleMenuClick(submenuId) {
            const sidebar = document.getElementById('sidebar');
            const submenu = document.getElementById(submenuId);

            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                submenu.style.display = "block";
            } else {
                submenu.style.display = (submenu.style.display === "none") ? "block" : "none";
            }
        }

        async function loadPage(pageName) {
            const content = document.getElementById('page-content');
            const topbarTitle = document.getElementById('topbar-title');
            let pageUrl = '';

            if (topbarTitle) {
                topbarTitle.innerHTML = `${pageName}`;
            }
            
            if (pageName === 'Usuários') {
                pageUrl = 'crud-usuarios.html'; 
                content.innerHTML = `<p class="text-secondary">Carregando módulo de Usuários...</p>`;
            } else if (pageName === 'Dashboard') {
                 content.innerHTML = `<h3>Dashboard</h3><div class="alert alert-info">Bem-vindo(a), **${perfilUsuario.nome_usu}**! Clique nos links do menu lateral para navegar!</div>`;
                return;
            } else {
                content.innerHTML = `<h3>${pageName}</h3><div class="alert alert-warning">Este módulo está em desenvolvimento.</div>`;
                return;
            }
            
            blockScreen();

            try {
                const response = await fetch(pageUrl);
                if (!response.ok) throw new Error('Não foi possível carregar o conteúdo da página.');
                
                content.innerHTML = await response.text();
                
                if (pageName === 'Usuários') {
                    initializeCrudListeners();
                    resetForm(); 
                    loadUsersTable();
                }

            } catch (error) {
                content.innerHTML = `<h3 class="text-danger">Erro ao Carregar</h3><p class="text-danger">Falha ao carregar o módulo de ${pageName}. Verifique se o arquivo ${pageUrl} existe.</p>`;
                console.error("Fetch Error:", error);
            } finally {
                unblockScreen();
            }
        }
        
        function renderMainPage(perfil) {
            const sessaoIdCurto = perfil.sessao_atual ? perfil.sessao_atual.substring(0, 8) : 'N/A';
            
            mainContainer.innerHTML = `
                <div class="main-wrapper" id="main-wrapper">
                    <div class="sidebar collapsed" id="sidebar">
                        <div class="menu-items">
                            <a href="javascript:void(0);" class="toggle-btn" onclick="toggleSidebar()">
                                <span class="icon">menu</span>
                                <span class="text">SIGMA</span>
                            </a>
                            <hr>

                            <div class="user-profile" id="user-profile-info">
                                <div class="user-greeting">Bem-vindo(a),</div>
                                <div class="user-name">${perfil.nome_usu || 'Usuário'}</div> 
                            </div>
                            <hr>

                            <a href="#" onclick="loadPage('Dashboard')"><span class="icon">home</span><span class="text">Dashboard</span></a>

                            <div class="menu-item">
                                <a href="#" onclick="handleMenuClick('cadastrosSub')">
                                    <span class="icon">engineering</span>
                                    <span class="text">Cadastros</span> 
                                    <span class="icon expand-icon" style="margin-left:auto;">expand_more</span>
                                </a>
                                <div class="submenu" id="cadastrosSub" style="display:none;">
                                    <a href="#" onclick="loadPage('Obras')"><span class="icon">format_list_bulleted</span><span class="text">Obras</span></a>
                                    
                                    <a href="#" onclick="loadPage('Usuários')"><span class="icon">person</span><span class="text">Usuários</span></a>
                                    
                                    <a href="#" onclick="loadPage('Departamentos')"><span class="icon">groups</span><span class="text">Departamentos</span></a>
                                </div>
                            </div>
                            
                            <a href="#" onclick="loadPage('Relatórios')"><span class="icon">bar_chart</span><span class="text">Relatórios</span></a>
                        </div>

                        <div class="logout-area">
                            <a href="#" onclick="handleLogout()">
                                <span class="icon">logout</span><span class="text">Sair</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="content-wrapper">
                        <div class="topbar" id="topbar-title">Menu Principal</div> 
                        <div class="content" id="page-content">
                            </div>
                        <div class="footer">
                            <span>SIGMA - Sistema Inteligente de Gestão &copy; 2025</span>
                            <span id="nivel-usuario">Perfil: ${perfil.nivel_usu || 'Padrão'} | Sessão ID: ${sessaoIdCurto}</span>
                        </div>
                    </div>
                </div>
            `;
            loadPage('Dashboard'); 
        }

        // =======================================================
        // LÓGICA DE CRUD DE USUÁRIOS (Omitido por brevidade)
        // =======================================================
        
        async function loadUsersTable() { /* ... */ }
        async function handleEditUser(userId) { /* ... */ }
        async function handleDeleteUser(userId, userName) { /* ... */ }
        async function handleCadastroUsuario() { /* ... */ }


        // =======================================================
        // FUNÇÕES DE AUTENTICAÇÃO
        // =======================================================
        
        async function handleLogin() {
            const email = document.getElementById('idUsu').value;
            const password = document.getElementById('senhaUsu').value;
            const feedback = document.getElementById('login-feedback');
            
            if(!email || !password){ Swal.fire("Atenção","Preencha E-mail e Senha","warning"); return; }
            
            blockScreen();
            feedback.style.display = 'none';

            const { data: authData, error: loginError } = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
            
            if (loginError) { 
                unblockScreen(); 
                feedback.textContent = "Credenciais inválidas. Verifique seu e-mail e senha."; 
                feedback.style.display = 'block'; 
                return; 
            }
            
            const userId = authData.user.id;
            const accessToken = authData.session.access_token; 
            
            let userSessionId = authData.session.id;
            if (!userSessionId) { userSessionId = generateUUID(); }

            const authenticatedClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                global: { headers: { Authorization: `Bearer ${accessToken}` } }
            });

            const { data: perfil, error: perfilError } = await authenticatedClient
                .from(TABLE_NAME).select(`id, bloqueado, cont_erro_login, primeiro_acesso, nome_usu, nivel_usu, sessao_atual`).eq('id', userId).single();
            
            if (perfilError || !perfil) { 
                await supabaseClient.auth.signOut(); 
                unblockScreen(); 
                Swal.fire("Erro de Sistema", "Perfil de usuário não encontrado. Contate o suporte.", "error"); 
                return; 
            }
            
            if (perfil.bloqueado) { 
                await supabaseClient.auth.signOut(); 
                unblockScreen(); 
                feedback.textContent = `Acesso bloqueado. Contate o administrador.`; 
                feedback.style.display = 'block'; 
                return; 
            }
            
            // Tratamento de Primeiro Acesso
            if (perfil.primeiro_acesso) { 
                unblockScreen(); 
                await supabaseClient.auth.setSession(authData.session);
                perfilUsuario = perfil;
                showChangePasswordForm(perfil); 
                return; 
            }
            
            // Tratamento de Concorrência de Sessão
            if (perfil.sessao_atual && perfil.sessao_atual !== userSessionId) {
                unblockScreen();
                Swal.fire({
                    title: "⚠️ Aviso de Sessão Ativa",
                    html: `<p>Detectamos outra sessão ativa. Deseja continuar e desconectar a outra sessão?</p>`,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Sim, Continuar",
                    cancelButtonText: "Não, Cancelar"
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        blockScreen();
                        await authenticatedClient.from(TABLE_NAME).update({ sessao_atual: userSessionId, cont_erro_login: 0 }).eq('id', perfil.id);
                        await supabaseClient.auth.setSession(authData.session);
                        perfilUsuario = perfil;
                        perfilUsuario.sessao_atual = userSessionId;
                        unblockScreen();
                        renderMainPage(perfilUsuario);
                    } else {
                        await supabaseClient.auth.signOut(); 
                        renderLogin();
                    }
                });
                return;
            }
            
            // Login OK: Atualiza a sessão no perfil 
            await authenticatedClient
                .from(TABLE_NAME)
                .update({ cont_erro_login: 0, sessao_atual: userSessionId })
                .eq('id', perfil.id);
            
            await supabaseClient.auth.setSession(authData.session);

            perfilUsuario = perfil;
            perfilUsuario.sessao_atual = userSessionId;

            unblockScreen();
            renderMainPage(perfilUsuario);
        }

        async function handleLogout() {
            blockScreen(); 
            if (perfilUsuario) {
                await supabaseClient.from(TABLE_NAME).update({ sessao_atual: null }).eq('id', perfilUsuario.id);
            }
            await supabaseClient.auth.signOut();
            sessaoIDAtual = null; 
            perfilUsuario = null;

            unblockScreen(); 
            renderLogin();
        }
        
        /**
         * @FLUXO_SUPABASE: Envia o link de redefinição de senha para o e-mail.
         */
        async function handlePasswordReset() {
            const email = document.getElementById("idUsu").value.trim();
            const feedback = document.getElementById('login-feedback');
            
            feedback.style.display = 'none';

            if (!email) { 
                feedback.textContent = "Preencha o E-mail para solicitar o link de redefinição de senha.";
                feedback.style.display = 'block';
                return; 
            }
            
            blockScreen();

            // O redirectTo é ESSENCIAL para que o initApp intercepte o token ao clicar no link.
            const { error: resetError } = await supabaseClient.auth.resetPasswordForEmail(email, { 
                redirectTo: window.location.origin + window.location.pathname 
            });
            
            unblockScreen();
            
            if (resetError) { 
                Swal.fire('Erro ao solicitar reset', resetError.message, 'error'); 
            } else { 
                Swal.fire('Instruções Enviadas!', 
                    'Se o e-mail estiver cadastrado, as instruções de redefinição foram enviadas. **Clique no link** no e-mail para definir sua nova senha.', 
                    'success'); 
            }
        }
        
        function showChangePasswordForm(perfil) {
            // Chamado no fluxo de Login/Primeiro Acesso
            document.getElementById('emailDiv').style.display = 'block'; 
            document.getElementById('senhaDiv').style.display='none';
            document.getElementById('novaSenhaDiv').style.display='block';
            document.getElementById('confSenhaDiv').style.display='block';
            document.getElementById('btnSalvarSenha').style.display='block';
            document.getElementById('btnLogin').style.display='none';
            document.getElementById('linkEsqueciSenha').style.display='none';
            document.getElementById('login-feedback').textContent = `Primeiro acesso detectado! Defina uma nova senha forte.`;
            document.getElementById('login-feedback').style.display = 'block';
            
            document.getElementById('btnSalvarSenha').onclick = salvarNovaSenha;
        }
        
        function validarForcaSenha(senha){
            if(senha.length < 8) return "A senha deve ter no mínimo 8 caracteres";
            if(!/[A-Z]/.test(senha)) return "A senha deve conter pelo menos uma letra maiúscula";
            if(!/[!@#$%^&*(),.?":{}|<>]/.test(senha)) return "A senha deve conter pelo menos um caractere especial";
            return null;
        }

        async function salvarNovaSenha() {
            // Salvar nova senha para PRIMEIRO ACESSO (após login inicial)
            const novaSenha = document.getElementById('novaSenha').value;
            const confSenha = document.getElementById('confSenha').value;

            if(!novaSenha || novaSenha!==confSenha){ Swal.fire('Erro','As senhas não conferem','error'); return; }
            const msgErro = validarForcaSenha(novaSenha);
            if(msgErro){ Swal.fire('Erro', msgErro, 'error'); return; }

            blockScreen();

            const { error: authError } = await supabaseClient.auth.updateUser({ password: novaSenha });
            if (authError) { unblockScreen(); Swal.fire('Erro','Falha ao atualizar senha no Auth: ' + authError.message,'error'); return; }

            const { error: perfilError } = await supabaseClient.from(TABLE_NAME).update({ primeiro_acesso: false }).eq('id', perfilUsuario.id);
            unblockScreen();
            
            if (perfilError) { 
                Swal.fire('Atenção', 'Senha atualizada, mas falha ao marcar o primeiro acesso no perfil.','warning').then(() => { handleLogout(); });
            } else { 
                Swal.fire('Sucesso','Senha atualizada! Faça login com a nova senha.','success').then(() => { handleLogout(); }); 
            }
        }
        
        /**
         * @FLUXO_SUPABASE: Salvar Senha após Clique no Link de Reset (Token)
         */
        async function handleResetByToken() {
            // Chamado após clicar no link do e-mail.
            const novaSenha = document.getElementById('novaSenha').value;
            const confSenha = document.getElementById('confSenha').value;

            if(!novaSenha || novaSenha!==confSenha){ Swal.fire('Erro','As senhas não conferem','error'); return; }
            const msgErro = validarForcaSenha(novaSenha);
            if(msgErro){ Swal.fire('Erro', msgErro, 'error'); return; }

            blockScreen();

            // 1. Atualiza a senha usando o token da URL/Sessão.
            const { error: authError } = await supabaseClient.auth.updateUser({ password: novaSenha });
            
            if (authError) { 
                unblockScreen(); 
                Swal.fire('Erro','Falha ao atualizar senha: ' + authError.message,'error'); 
                return; 
            }
            
            // 2. Remove o status de primeiro acesso (se existir)
            const { data: { user } } = await supabaseClient.auth.getUser();
            if(user) {
                 await supabaseClient.from(TABLE_NAME).update({ primeiro_acesso: false }).eq('id', user.id);
            }
            
            // 3. Força um logout seguro para limpar a sessão de reset.
            await supabaseClient.auth.signOut();
            
            // 4. Limpa os parâmetros da URL.
            history.replaceState(null, '', window.location.pathname); 

            Swal.fire('Sucesso','Senha redefinida com sucesso! Faça login com sua nova senha.','success').then(() => { 
                unblockScreen();
                renderLogin(); // Volta para a tela de login limpa
            });
        }


        // =======================================================
        // INICIALIZAÇÃO E TRATAMENTO DE EVENTOS DE AUTENTICAÇÃO
        // =======================================================
        function initApp() {
            blockScreen();
            
            const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
                
                // --- 1. TRATAMENTO DO FLUXO DE RECUPERAÇÃO DE SENHA ---
                if (event === 'PASSWORD_RECOVERY') {
                    
                    // 1. Renderiza o HTML base do login
                    renderLogin(); 
                    
                    // 2. Limpa os parâmetros de token da URL imediatamente
                    history.replaceState(null, '', window.location.pathname);
                    
                    // 3. Força a UI a mostrar APENAS os campos de nova senha
                    document.getElementById('emailDiv').style.display='none'; 
                    document.getElementById('senhaDiv').style.display='none'; 
                    
                    document.getElementById('novaSenhaDiv').style.display='block';
                    document.getElementById('confSenhaDiv').style.display='block';
                    document.getElementById('btnSalvarSenha').style.display='block';
                    document.getElementById('btnLogin').style.display='none';
                    document.getElementById('linkEsqueciSenha').style.display='none';
                    
                    document.getElementById('login-feedback').textContent = `Defina sua nova senha.`;
                    document.getElementById('login-feedback').style.display = 'block';

                    // 4. Configura o botão para a função que usa o token temporário
                    document.getElementById('btnSalvarSenha').onclick = handleResetByToken;

                    unblockScreen();
                    return;
                }

                // --- 2. TRATAMENTO DA SESSÃO NORMAL ---
                if (session) {
                    // Usuário logado ou acabou de completar um fluxo
                    
                    if (perfilUsuario && perfilUsuario.id === session.user.id) {
                        unblockScreen();
                        return; 
                    }
                    
                    // Busca perfil e renderiza o dashboard
                    const { data: perfil } = await supabaseClient
                        .from(TABLE_NAME).select(`id, bloqueado, cont_erro_login, primeiro_acesso, nome_usu, nivel_usu, sessao_atual`).eq('id', session.user.id).single();
                    
                    if (perfil && !perfil.bloqueado) {
                        perfilUsuario = perfil;
                        renderMainPage(perfilUsuario);
                    } else {
                        await supabaseClient.auth.signOut();
                        renderLogin();
                    }

                } else {
                    // Usuário deslogado
                    if (!perfilUsuario) {
                         renderLogin();
                    }
                }
                
                unblockScreen();
            });
            
            window.addEventListener('unload', () => {
                subscription.unsubscribe();
            });
        }

        initApp();
    </script>
</body>
</html>
