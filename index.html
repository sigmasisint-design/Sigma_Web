<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%231565C0%22><path d=%22M11 20v-5h-4l6-11v5h4l-6 11z%22/><text x=%2222%22 y=%2220%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%231565C0%22>Σ</text></svg>">
    <title>SIGMA - Gestão Inteligente</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        /* CSS Omitido para Brevidade, mas Completo na Sua Versão */
        html, body {
            height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif;
            font-size: 0.95rem; color: #1565C0; background: #f5f6fa;
        }
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-card {
            background: #fff; padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
        }
        .login-card h4 { text-align: center; margin: 0; line-height: 1; color: #1565C0; font-size: 2.2rem; }
        .login-card .subtitulo { font-size: 0.85rem; text-align: center; color: #1565C0; margin: 0; line-height: 1; }
        .login-card .form-label { margin-bottom: 2px; color: #1565C0; }
        .login-card .btn-primary, .btn-success{background: #1565C0; border-color: #1565C0;}
        #screen-blocker { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.5); z-index: 9999; cursor: progress; }
        .login-card #linkEsqueciSenha { color: #1565C0; text-decoration: none; }
    </style>
</head>
<body>
    <div id="main-container"></div>
    <div id="screen-blocker"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // =======================================================
        // CONSTANTES E INICIALIZAÇÃO DO SUPABASE
        // =======================================================
        const SUPABASE_URL = 'https://nxgccbvfcxbukhciknoo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54Z2NjYnZmY3hidWtoY2lrbm9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyODkzMDAsImV4cCI6MjA3Mzg2NTMwMH0.8iTGv8HzocnJBXB9xT5VUNbwidceKIIbZDuwhGKnahk';
        const TABLE_NAME = 'perfis';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let perfilUsuario = null; 

        const mainContainer = document.getElementById("main-container");
        const screenBlocker = document.getElementById('screen-blocker');

        // =======================================================
        // FUNÇÕES UTILITÁRIAS
        // =======================================================
        function blockScreen() { screenBlocker.style.display='block'; }
        function unblockScreen() { screenBlocker.style.display='none'; }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function validarForcaSenha(senha){
            if(senha.length < 8) return "A senha deve ter no mínimo 8 caracteres";
            if(!/[A-Z]/.test(senha)) return "A senha deve conter pelo menos uma letra maiúscula";
            if(!/[!@#$%^&*(),.?":{}|<>]/.test(senha)) return "A senha deve conter pelo menos um caractere especial";
            return null;
        }

        // =======================================================
        // FUNÇÕES DE INTERFACE (LOGIN/DASHBOARD)
        // =======================================================
        
        function renderLogin() {
            // 1. Renderiza o HTML COMPLETO da tela de login
            mainContainer.innerHTML = `
                <div class="login-container" id="login-container">
                    <div class="login-card">
                        <h4>SIGMA</h4>
                        <div class="subtitulo">Gestão Inteligente</div>
                        
                        <div class="mb-3 mt-3" id="emailDiv">
                            <label for="idUsu" class="form-label">E-mail:</label>
                            <input type="email" id="idUsu" class="form-control" placeholder="Digite seu E-mail" required>
                        </div>

                        <div class="mb-3" id="senhaDiv">
                            <label for="senhaUsu" class="form-label">Senha:</label>
                            <input type="password" id="senhaUsu" class="form-control" placeholder="Digite sua senha" required>
                        </div>

                        <div class="mb-3" id="novaSenhaDiv">
                            <label for="novaSenha" class="form-label">Nova Senha:</label>
                            <input type="password" id="novaSenha" class="form-control" placeholder="Digite a nova senha">
                        </div>

                        <div class="mb-3" id="confSenhaDiv">
                            <label for="confSenha" class="form-label">Confirme a Senha:</label>
                            <input type="password" id="confSenha" class="form-control" placeholder="Confirme a nova senha">
                        </div>

                        <button class="btn btn-primary w-100" id="btnLogin" onclick="handleLogin()">Entrar</button>
                        <button class="btn btn-success w-100" id="btnSalvarSenha">Salvar Senha</button>

                        <p id="login-feedback" class="text-danger text-center mt-2"></p>

                        <div class="text-center mt-2">
                            <a href="javascript:void(0);" id="linkEsqueciSenha" onclick="handlePasswordReset()">Esqueci minha senha</a>
                        </div>
                    </div>
                </div>
            `;
            
            // 2. Garante o estado inicial (LOGIN PADRÃO)
            // ESTA É A PARTE CRÍTICA E CORRIGIDA: Forçar os elementos a se esconderem APÓS a renderização do HTML.
            document.getElementById('novaSenhaDiv').style.display = 'none';
            document.getElementById('confSenhaDiv').style.display = 'none';
            document.getElementById('btnSalvarSenha').style.display = 'none';
            document.getElementById('login-feedback').style.display = 'none';
            
            document.getElementById('emailDiv').style.display = 'block';
            document.getElementById('senhaDiv').style.display = 'block';
            document.getElementById('btnLogin').style.display = 'block';
            document.getElementById('linkEsqueciSenha').style.display = 'block';

            // Configuração do botão de salvar senha (para primeiro acesso)
            const btnSalvar = document.getElementById('btnSalvarSenha');
            if (btnSalvar) {
                 btnSalvar.onclick = salvarNovaSenha; 
            }
        }
        
        // [Funções de Dashboard Omitidas para Brevidade]
        function renderMainPage(perfil) { /* ... */ }

        // =======================================================
        // FUNÇÕES DE AUTENTICAÇÃO (Essenciais)
        // =======================================================
        
        async function handleLogin() {
            const email = document.getElementById('idUsu').value;
            const password = document.getElementById('senhaUsu').value;
            if(!email || !password){ Swal.fire("Atenção","Preencha E-mail e Senha","warning"); return; }
            Swal.fire("Aviso", "Lógica de login real omitida para focar no reset. Assumindo falha/necessidade de Supabase.", "info"); 
            unblockScreen();
        }

        async function handleLogout() {
            perfilUsuario = null;
            unblockScreen(); 
            renderLogin();
        }
        
        /**
         * @FLUXO_SUPABASE: Inicia a solicitação de redefinição.
         */
        async function handlePasswordReset() {
            const email = document.getElementById("idUsu").value.trim();
            const feedback = document.getElementById('login-feedback');
            
            feedback.style.display = 'none';

            if (!email) { 
                feedback.textContent = "Preencha o E-mail para solicitar o link de redefinição de senha.";
                feedback.style.display = 'block';
                return; 
            }
            
            blockScreen();

            const { error: resetError } = await supabaseClient.auth.resetPasswordForEmail(email, { 
                redirectTo: window.location.origin + window.location.pathname 
            });
            
            unblockScreen();
            
            if (resetError) { 
                Swal.fire('Erro ao solicitar reset', resetError.message, 'error'); 
            } else { 
                Swal.fire('Instruções Enviadas!', 
                    'Se o e-mail estiver cadastrado, as instruções de redefinição foram enviadas. **Clique no link** no e-mail para definir sua nova senha.', 
                    'success'); 
            }
        }
        
        async function salvarNovaSenha() {
            Swal.fire('Aviso', 'Função de salvar nova senha (Primeiro Acesso) omitida.', 'warning');
        }
        
        /**
         * @FLUXO_SUPABASE: Salva a nova senha após clicar no link do e-mail.
         */
        async function handleResetByToken() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confSenha = document.getElementById('confSenha').value;

            if(!novaSenha || novaSenha!==confSenha){ Swal.fire('Erro','As senhas não conferem','error'); return; }
            
            blockScreen();

            const { error: authError } = await supabaseClient.auth.updateUser({ password: novaSenha });
            
            if (authError) { 
                unblockScreen(); 
                Swal.fire('Erro','Falha ao atualizar senha: ' + authError.message,'error'); 
                return; 
            }
            
            // Lógica para limpar o status de primeiro acesso (se aplicável)
            await supabaseClient.auth.signOut();
            history.replaceState(null, '', window.location.pathname); 

            Swal.fire('Sucesso','Senha redefinida com sucesso! Faça login com sua nova senha.','success').then(() => { 
                unblockScreen();
                renderLogin(); 
            });
        }


        // =======================================================
        // INICIALIZAÇÃO E TRATAMENTO DE EVENTOS DE AUTENTICAÇÃO
        // =======================================================
        function initApp() {
            blockScreen();
            
            const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
                
                // --- 1. TRATAMENTO DO FLUXO DE RECUPERAÇÃO DE SENHA (Token detectado) ---
                if (event === 'PASSWORD_RECOVERY') {
                    
                    renderLogin(); // Garante que a estrutura HTML está pronta
                    history.replaceState(null, '', window.location.pathname); 
                    
                    // FORÇA a UI a mostrar APENAS os campos de nova senha
                    document.getElementById('emailDiv').style.display='none'; 
                    document.getElementById('senhaDiv').style.display='none'; 
                    document.getElementById('btnLogin').style.display='none';
                    document.getElementById('linkEsqueciSenha').style.display='none';
                    
                    document.getElementById('novaSenhaDiv').style.display='block';
                    document.getElementById('confSenhaDiv').style.display='block';
                    document.getElementById('btnSalvarSenha').style.display='block';
                    
                    document.getElementById('login-feedback').textContent = `Defina sua nova senha.`;
                    document.getElementById('login-feedback').style.display = 'block';

                    // Configura o botão para a função de troca de senha via TOKEN
                    document.getElementById('btnSalvarSenha').onclick = handleResetByToken;

                    unblockScreen();
                    return;
                }

                // --- 2. TRATAMENTO DA SESSÃO NORMAL ---
                if (session) {
                    // Se houver sessão (usuário logado), pula para o Dashboard
                    // Aqui seria a lógica de renderMainPage(perfilUsuario)
                    unblockScreen();
                    Swal.fire("Sessão Ativa", "Dashboard seria renderizado aqui.", "info");

                } else {
                    // Usuário deslogado. Renderiza o Login (Abre a tela inicial)
                    if (!perfilUsuario) {
                         renderLogin();
                    }
                }
                
                unblockScreen();
            });
        }

        // Chama a função de inicialização imediatamente
        initApp();
    </script>
</body>
</html>
