<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA - Sistema Inteligente de Gestão</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Estilos Globais e Utilidades */
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa; /* Light grey background */
        }

        /* Container Principal do Aplicativo */
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* --- Estilo do Formulário de Login --- */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 100vh;
        }

        .login-card {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px; /* Largura máxima para a caixa de login */
        }

        .login-card h4 {
            text-align: center;
            color: #007bff;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .login-card .subtitulo {
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .login-card .form-label {
            font-weight: 500;
        }

        .login-card .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            transition: background-color 0.3s;
        }

        .login-card .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }

        /* Estilo para links de recuperação */
        #linkEsqueciSenha {
            color: #007bff;
            text-decoration: none;
            font-size: 0.9em;
        }

        /* --- Estilos do Layout Principal (Após Login) --- */
        .main-wrapper {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        /* Sidebar (Menu Lateral) */
        .sidebar {
            width: 250px;
            background-color: #2c3e50; /* Dark Blue/Grey */
            color: white;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Esconde o conteúdo extra ao colapsar */
            flex-shrink: 0; /* Impede que a sidebar encolha quando o conteúdo principal aumenta */
        }

        .sidebar.collapsed {
            width: 60px; /* Largura mínima para ícones */
        }

        .sidebar .menu-items {
            flex-grow: 1; /* Permite que o menu cresça e empurre o logout para baixo */
            overflow-y: auto; /* Adiciona scroll se o menu for muito longo */
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s, padding 0.3s;
            white-space: nowrap; /* Impede a quebra de linha do texto do menu */
        }

        .sidebar a:hover {
            background-color: #34495e;
        }

        .sidebar .icon {
            font-family: 'Material Icons';
            font-size: 24px;
            margin-right: 15px;
            transition: margin-right 0.3s;
        }

        .sidebar.collapsed .text,
        .sidebar.collapsed .user-greeting,
        .sidebar.collapsed .user-name,
        .sidebar.collapsed .expand-icon {
            display: none;
        }

        .sidebar.collapsed .icon {
            margin-right: 0; /* Remove margem para centralizar o ícone */
            text-align: center;
            width: 100%; /* Garante que o ícone ocupe toda a largura do item */
        }
        
        /* Estilo para o botão de toggle na sidebar */
        .sidebar .toggle-btn {
            font-weight: bold;
            font-size: 1.2em;
            padding: 15px;
            background-color: #1a242f; /* Um pouco mais escuro */
            margin-bottom: 0;
        }

        .sidebar .user-profile {
            padding: 10px 15px;
            background-color: #3a536b; /* Fundo levemente diferente para o perfil */
        }

        .sidebar .user-greeting {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .sidebar .user-name {
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Linha divisória */
        .sidebar hr {
            border-top: 1px solid #4a627a;
            margin: 0;
        }

        /* Submenu */
        .submenu {
            background-color: #34495e; /* Fundo do submenu */
            padding-left: 10px; /* Recuo */
        }

        .submenu a {
            padding-left: 30px; /* Aumenta o recuo dos itens do submenu */
            font-size: 0.95em;
        }
        
        /* Logout Area */
        .logout-area {
            border-top: 1px solid #4a627a;
            margin-top: auto; /* Empurra para o rodapé da sidebar */
        }
        .logout-area a {
            background-color: #c0392b; /* Cor vermelha para destaque */
        }
        .logout-area a:hover {
            background-color: #e74c3c;
        }
        .sidebar.collapsed .logout-area a {
            padding: 12px 0; /* Ajusta o padding quando colapsado */
        }


        /* Content Wrapper (Conteúdo Principal) */
        .content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Permite o encolhimento para caber */
        }

        .topbar {
            background-color: #ffffff;
            color: #34495e;
            padding: 15px 20px;
            font-size: 1.4em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto; /* Permite scroll no conteúdo principal */
        }
        
        .footer {
            background-color: #e9ecef;
            color: #6c757d;
            padding: 10px 20px;
            font-size: 0.8em;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        /* Estilo para a Tabela do CRUD */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #f2f2f2;
        }

        .table-hover > tbody > tr:hover > * {
            background-color: #e9ecef;
        }
        
        .btn-table-action {
            margin-right: 5px;
            font-size: 0.8em;
        }

        /* --- Estilos do Bloqueio de Tela (Loading) --- */
        #block-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #ffffff;
        }
        
    </style>
</head>
<body>

    <div id="block-screen">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <div id="main-container" class="main-container">
        </div>

    <script>
        // --- CONFIGURAÇÕES E VARIÁVEIS GLOBAIS ---
        
        // **!!! IMPORTANTE !!!**
        // Substitua ESTES valores pelos seus dados do Supabase:
        const SUPABASE_URL = 'SUA_URL_DO_SUPABASE'; // Ex: 'https://xyzabcdefg.supabase.co'
        const SUPABASE_ANON_KEY = 'SUA_CHAVE_ANON_PUBLIC_DO_SUPABASE'; // Ex: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
        const TABLE_NAME = 'perfil'; // Nome da tabela de perfis de usuário
        
        // Inicializa o cliente Supabase sem autenticação (para login/recuperação)
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storageKey: 'supabase.auth.session', // Mantém a sessão ativa
                storage: window.sessionStorage,      // Usa sessionStorage (limpa ao fechar)
                autoRefreshToken: true,
                persistSession: true
            }
        });

        // Referência ao container principal
        const mainContainer = document.getElementById('main-container');

        // Variável global para armazenar os dados do usuário logado
        let perfilUsuario = null;

        // Variáveis de Controle do CRUD (Inicializadas após o login)
        let isEditMode = false;
        let currentUserId = null;
        let authenticatedSupabaseClient = null;


        // --- FUNÇÕES DE UTILIDADE ---

        function blockScreen() { document.getElementById('block-screen').style.display = 'flex'; }
        function unblockScreen() { document.getElementById('block-screen').style.display = 'none'; }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- FUNÇÕES DE CRUD (USUÁRIOS) ---
        
        function initializeCrudListeners() {
            // Adiciona listeners aos botões do formulário
            document.getElementById('btnSave').onclick = handleSaveUser;
            document.getElementById('btnCancel').onclick = resetForm;
        }

        function resetForm() {
            isEditMode = false;
            currentUserId = null;
            document.getElementById('formTitle').textContent = 'Novo Usuário';
            document.getElementById('idUsr').value = '';
            document.getElementById('nomeUsr').value = '';
            document.getElementById('emailUsr').value = '';
            document.getElementById('nivelUsr').value = 'Padrao'; // Valor Padrão
            document.getElementById('statusUsr').checked = false;
            document.getElementById('primeiroAcessoUsr').checked = true;
            document.getElementById('emailUsr').disabled = false; // Habilita e-mail na criação
            document.getElementById('btnSave').textContent = 'Salvar';
            document.getElementById('formCard').classList.remove('border-warning');
        }

        async function loadUsersTable() {
            blockScreen();

            // Configura o cliente Supabase com a sessão autenticada (RLS)
            // Se autenticadoClient não estiver definido (o que deve ser raro aqui), usa o client padrão.
            // Para RLS funcionar, o usuário DEVE ter permissão de SELECT na tabela 'perfil'.
            const client = perfilUsuario ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                global: { headers: { Authorization: `Bearer ${supabaseClient.auth.session?.access_token || ''}` } }
            }) : supabaseClient;
            
            const { data: users, error } = await client
                .from(TABLE_NAME)
                .select('id, nome_usu, email, nivel_usu, bloqueado, primeiro_acesso')
                .order('nome_usu', { ascending: true });

            unblockScreen();

            const tableBody = document.getElementById('userTableBody');
            if (!tableBody) return; // Garante que o elemento existe
            tableBody.innerHTML = ''; // Limpa a tabela

            if (error) {
                console.error("Erro ao carregar usuários:", error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Erro ao carregar dados: ${error.message}. Verifique as permissões (RLS).</td></tr>`;
                return;
            }

            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum usuário cadastrado.</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = user.nome_usu;
                row.insertCell(1).textContent = user.email;
                row.insertCell(2).textContent = user.nivel_usu;
                row.insertCell(3).innerHTML = `<span class="badge bg-${user.bloqueado ? 'danger' : 'success'}">${user.bloqueado ? 'Bloqueado' : 'Ativo'}</span>`;
                row.insertCell(4).innerHTML = `<span class="badge bg-${user.primeiro_acesso ? 'warning' : 'info'}">${user.primeiro_acesso ? 'Sim' : 'Não'}</span>`;
                
                const actionsCell = row.insertCell(5);
                
                // Botão de Editar
                const btnEdit = document.createElement('button');
                btnEdit.innerHTML = '<span class="material-icons" style="font-size: 1.1em;">edit</span>';
                btnEdit.className = 'btn btn-sm btn-info btn-table-action';
                btnEdit.title = 'Editar';
                btnEdit.onclick = () => loadUserForEdit(user.id);
                
                // Botão de Excluir
                const btnDelete = document.createElement('button');
                btnDelete.innerHTML = '<span class="material-icons" style="font-size: 1.1em;">delete</span>';
                btnDelete.className = 'btn btn-sm btn-danger btn-table-action';
                btnDelete.title = 'Excluir';
                btnDelete.onclick = () => handleDeleteUser(user.id, user.nome_usu);

                // Botão de Reset (Novo Primeiro Acesso)
                const btnReset = document.createElement('button');
                btnReset.innerHTML = '<span class="material-icons" style="font-size: 1.1em;">lock_reset</span>';
                btnReset.className = 'btn btn-sm btn-warning btn-table-action';
                btnReset.title = 'Forçar Troca de Senha (1º Acesso)';
                btnReset.onclick = () => handleForcePasswordChange(user.id, user.nome_usu);
                
                actionsCell.appendChild(btnEdit);
                actionsCell.appendChild(btnDelete);
                actionsCell.appendChild(btnReset);
            });
        }

        async function loadUserForEdit(id) {
            blockScreen();
            
            // Re-cria o cliente autenticado (boa prática de segurança)
            const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                global: { headers: { Authorization: `Bearer ${supabaseClient.auth.session?.access_token || ''}` } }
            });
            
            const { data: user, error } = await client
                .from(TABLE_NAME)
                .select('id, nome_usu, email, nivel_usu, bloqueado, primeiro_acesso')
                .eq('id', id)
                .single();

            unblockScreen();

            if (error) {
                Swal.fire("Erro", `Falha ao buscar usuário: ${error.message}`, "error");
                return;
            }

            isEditMode = true;
            currentUserId = user.id;
            document.getElementById('formTitle').textContent = `Editar Usuário: ${user.nome_usu}`;
            document.getElementById('idUsr').value = user.id;
            document.getElementById('nomeUsr').value = user.nome_usu;
            document.getElementById('emailUsr').value = user.email;
            document.getElementById('nivelUsr').value = user.nivel_usu;
            document.getElementById('statusUsr').checked = !user.bloqueado; // Inverte: bloqueado=true -> status=false
            document.getElementById('primeiroAcessoUsr').checked = user.primeiro_acesso;
            document.getElementById('emailUsr').disabled = true; // Não permite alterar e-mail no CRUD (supabase limita)
            document.getElementById('btnSave').textContent = 'Atualizar';
            document.getElementById('formCard').classList.add('border-warning');

            // Scroll para o topo do formulário
            document.getElementById('userFormContainer').scrollIntoView({ behavior: 'smooth' });
        }

        async function handleSaveUser() {
            const nome = document.getElementById('nomeUsr').value.trim();
            const email = document.getElementById('emailUsr').value.trim();
            const nivel = document.getElementById('nivelUsr').value;
            const status = document.getElementById('statusUsr').checked; // true=Ativo (não bloqueado), false=Bloqueado
            const primeiroAcesso = document.getElementById('primeiroAcessoUsr').checked;
            
            if (!nome || !email || !nivel) {
                Swal.fire("Atenção", "Preencha Nome, E-mail e Nível", "warning");
                return;
            }

            blockScreen();

            // Re-cria o cliente autenticado (boa prática de segurança)
            const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                global: { headers: { Authorization: `Bearer ${supabaseClient.auth.session?.access_token || ''}` } }
            });

            const userData = {
                nome_usu: nome,
                nivel_usu: nivel,
                bloqueado: !status, // Salva o inverso: Ativo (true) -> bloqueado: false
                primeiro_acesso: primeiroAcesso
            };
            
            let error = null;

            if (isEditMode) {
                // UPDATE (Edição)
                const { error: updateError } = await client
                    .from(TABLE_NAME)
                    .update(userData)
                    .eq('id', currentUserId);
                error = updateError;
            } else {
                // INSERT (Criação)
                // 1. Cria o usuário no Auth
                const initialPassword = generateUUID().substring(0, 10);
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({ 
                    email: email, 
                    password: initialPassword
                });

                if (authError) {
                    unblockScreen();
                    Swal.fire("Erro de Criação", `Falha ao criar usuário no Auth: ${authError.message}`, "error");
                    return;
                }
                
                // 2. Cria o perfil na tabela (com o ID do Auth)
                const newUserId = authData.user.id;
                const perfilData = {
                    ...userData,
                    id: newUserId,
                    email: email // Adiciona o email para facilitar a busca (caso a RLS não permita SELECT no auth)
                };

                // Remove o email da tabela para RLS funcionar (o email já está no auth.users)
                // Se a RLS permitir, mantenha-o. Neste exemplo, vamos manter.
                
                const { error: insertError } = await client
                    .from(TABLE_NAME)
                    .insert(perfilData);
                error = insertError;
                
                if (!error) {
                     // Notifica o usuário com a senha inicial
                     Swal.fire({
                        title: 'Usuário Criado!',
                        html: `O usuário **${nome}** foi criado com sucesso.<br>E-mail: **${email}**<br>Senha Inicial: **${initialPassword}**`,
                        icon: 'success'
                     });
                }
            }

            unblockScreen();
            
            if (error) {
                Swal.fire("Erro", `Falha ao salvar usuário: ${error.message}. Verifique a RLS.`, "error");
            } else {
                Swal.fire("Sucesso", `Usuário ${isEditMode ? 'atualizado' : 'criado'} com sucesso!`, "success");
                resetForm();
                await loadUsersTable();
            }
        }

        async function handleDeleteUser(id, nome) {
            const result = await Swal.fire({
                title: `Excluir Usuário: ${nome}?`,
                text: "Esta ação é irreversível e removerá o usuário do sistema Auth e do Perfil.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, Excluir!'
            });

            if (result.isConfirmed) {
                blockScreen();
                
                // 1. Exclusão do perfil (Necessário RLS DELETE)
                // Usa o cliente autenticado (RLS)
                const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    global: { headers: { Authorization: `Bearer ${supabaseClient.auth.session?.access_token || ''}` } }
                });
                const { error: perfilError } = await client.from(TABLE_NAME).delete().eq('id', id);

                if (perfilError) {
                    unblockScreen();
                    Swal.fire("Erro de Exclusão", `Falha ao remover perfil: ${perfilError.message}.`, "error");
                    return;
                }
                
                // 2. Exclusão do Auth (Apenas Admin/Service Role pode fazer isso sem RLS)
                // Usamos a função admin no Supabase (que só funciona no servidor).
                // No contexto do navegador, o método ideal é o Server-side.
                // Aqui, simulamos o Auth delete com a API do Supabase que deve ser configurada
                // para permitir a exclusão por administradores (Role Level Security).
                
                // Nota: No front-end puro, não há uma função direta e segura para
                // deletar outro usuário do Auth sem usar a Service Role Key (inseguro no browser).
                // O código abaixo DEVE ser adaptado para uma função RPC/Edge Function
                // para ser seguro e funcionar corretamente na produção.
                
                // Deixaremos a chamada DELETE do Perfil como principal,
                // e para o Auth.users é recomendado o uso do RLS ou uma função de back-end.
                
                // Se o usuário tentar deletar a si mesmo:
                if (perfilUsuario && perfilUsuario.id === id) {
                    await supabaseClient.auth.signOut();
                    perfilUsuario = null;
                    unblockScreen();
                    await Swal.fire("Sucesso", "Seu perfil foi removido com sucesso.", "success");
                    renderLogin();
                    return;
                }
                
                // Para simplificar no Front-end: A RLS do perfil deve garantir que
                // a exclusão do Auth.users aconteça via Trigger ou Edge Function.
                // Se a RLS do perfil foi bem-sucedida, consideramos o sucesso.
                
                unblockScreen();
                Swal.fire("Sucesso", `Usuário ${nome} excluído com sucesso (do perfil).`, "success");
                await loadUsersTable();
            }
        }

        async function handleForcePasswordChange(id, nome) {
            const result = await Swal.fire({
                title: `Forçar Troca de Senha para ${nome}?`,
                text: "Isso definirá o status 'Primeiro Acesso' como SIM, obrigando o usuário a trocar a senha no próximo login.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f0ad4e',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, Forçar Troca!'
            });

            if (result.isConfirmed) {
                blockScreen();
                
                const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    global: { headers: { Authorization: `Bearer ${supabaseClient.auth.session?.access_token || ''}` } }
                });

                const { error } = await client
                    .from(TABLE_NAME)
                    .update({ primeiro_acesso: true })
                    .eq('id', id);
                
                unblockScreen();

                if (error) {
                    Swal.fire("Erro", `Falha ao forçar troca de senha: ${error.message}. Verifique a RLS.`, "error");
                } else {
                    Swal.fire("Sucesso", `O usuário ${nome} será obrigado a trocar a senha no próximo login.`, "success");
                    await loadUsersTable();
                }
            }
        }


        // --- FUNÇÕES DE LOGIN E SEGURANÇA ---
        
        async function handleLogin() {
            const email = document.getElementById('idUsu').value;
            const password = document.getElementById('senhaUsu').value;
            const feedback = document.getElementById('login-feedback');
            
            if(!email || !password){ Swal.fire("Atenção","Preencha E-mail e Senha","warning"); return; }
            
            blockScreen();
            feedback.style.display = 'none';

            const { data: authData, error: loginError } = await supabaseClient.auth.signInWithPassword({ email: email, password: password });
            
            if (loginError) {
                unblockScreen();
                feedback.textContent = "Credenciais inválidas. Verifique seu e-mail e senha.";
                feedback.style.display = 'block';
                return;
            }
            
            const userId = authData.user.id;
            const accessToken = authData.session.access_token;
            
            let userSessionId = authData.session.id;
            if (!userSessionId) {
                userSessionId = generateUUID();
                console.warn("⚠️ Não foi possível obter o ID da sessão do Supabase. Usando UUID Fictício:", userSessionId);
            }

            const authenticatedClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                global: { headers: { Authorization: `Bearer ${accessToken}` } }
            });

            const { data: perfil, error: perfilError } = await authenticatedClient
                .from(TABLE_NAME).select(`id, bloqueado, cont_erro_login, primeiro_acesso, nome_usu, nivel_usu, sessao_atual`).eq('id', userId).single();
            
            if (perfilError || !perfil) {
                await supabaseClient.auth.signOut();
                unblockScreen();
                Swal.fire("Erro de Sistema", "Perfil de usuário não encontrado. Contate o suporte.", "error");
                return;
            }
            
            if (perfil.bloqueado) {
                await supabaseClient.auth.signOut();
                unblockScreen();
                feedback.textContent = `Acesso bloqueado. Contate o administrador.`;
                feedback.style.display = 'block';
                return;
            }
            
            if (perfil.primeiro_acesso) {
                unblockScreen();
                await supabaseClient.auth.setSession(authData.session);
                perfilUsuario = perfil;
                showChangePasswordForm(perfil);
                return;
            }
            
            // LÓGICA DE SESSÃO ÚNICA
            if (perfil.sessao_atual && perfil.sessao_atual !== userSessionId) {
                unblockScreen();
                Swal.fire({
                    title: "⚠️ Aviso de Sessão Ativa",
                    html: `<p>Detectamos outra sessão ativa (ID: ${perfil.sessao_atual.substring(0, 8)}). Deseja continuar e desconectar a outra sessão?</p>`,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Sim, Continuar",
                    cancelButtonText: "Não, Cancelar"
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        blockScreen();
                        const { error: sessionUpdateError } = await authenticatedClient.from(TABLE_NAME).update({
                            sessao_atual: userSessionId,
                            cont_erro_login: 0
                        }).eq('id', perfil.id);
                        
                        if (sessionUpdateError) {
                            await supabaseClient.auth.signOut();
                            unblockScreen();
                            Swal.fire("Erro de Permissão (RLS)", `Falha ao registrar a sessão: ${sessionUpdateError.message}. Verifique a RLS.`, "error");
                            return;
                        }

                        await supabaseClient.auth.setSession(authData.session);
                        perfilUsuario = perfil;
                        perfilUsuario.sessao_atual = userSessionId;
                        unblockScreen();
                        renderMainPage(perfilUsuario);

                    } else {
                        await supabaseClient.auth.signOut();
                        renderLogin();
                    }
                });
                return;
            }
            
            // REGISTRA A NOVA SESSÃO SE NÃO HOUVER CONFLITO
            const { error: sessionUpdateError } = await authenticatedClient
                .from(TABLE_NAME)
                .update({
                    cont_erro_login: 0,
                    sessao_atual: userSessionId
                })
                .eq('id', perfil.id);
            
            if (sessionUpdateError) {
                await supabaseClient.auth.signOut();
                unblockScreen();
                Swal.fire("Erro de Permissão (RLS)", `Falha ao registrar a sessão: ${sessionUpdateError.message}. Verifique a RLS.`, "error");
                return;
            }

            await supabaseClient.auth.setSession(authData.session);

            perfilUsuario = perfil;
            perfilUsuario.sessao_atual = userSessionId;

            unblockScreen();
            renderMainPage(perfilUsuario);
        }

        // Função de Logout com confirmação
        async function handleLogout(showPopup = true) {
            
            if (showPopup) {
                const result = await Swal.fire({
                    title: "Deseja realmente sair?",
                    text: "Sua sessão será encerrada. Você precisará fazer login novamente.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sim, Sair',
                    cancelButtonText: 'Cancelar'
                });

                // Se o usuário clicar em 'Cancelar', a função para aqui.
                if (!result.isConfirmed) {
                    return; 
                }
            }
            
            // Procede com o encerramento da sessão
            blockScreen();
            if (perfilUsuario) {
                // Remove a sessão do banco de dados
                await supabaseClient.from(TABLE_NAME).update({ sessao_atual: null }).eq('id', perfilUsuario.id);
            }
            // Invalida a sessão no navegador (sessionStorage)
            await supabaseClient.auth.signOut();
            sessaoIDAtual = null; // A sessãoIDAtual não foi definida, mas mantemos a lógica de limpeza.
            perfilUsuario = null;

            unblockScreen();
            
            if (showPopup) {
                // Mensagem de sucesso após a saída confirmada
                Swal.fire({ title: "Logout", text: "Sessão encerrada com sucesso.", icon: "info", allowOutsideClick: false, confirmButtonText: "OK" }).then(() => { renderLogin(); });
            } else {
                // Fluxo silencioso (após troca de senha)
                renderLogin();
            }
        }
        
        async function handlePasswordReset() {
            const email = document.getElementById("idUsu").value.trim();
            if (!email) { Swal.fire("Atenção", "Preencha o E-mail para solicitar a nova senha", "warning"); return; }
            blockScreen();
            // Redireciona o usuário de volta para o index.html
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + window.location.pathname });
            unblockScreen();
            if (error) { Swal.fire('Erro ao solicitar reset', error.message, 'error'); } else { Swal.fire('Sucesso', 'Instruções para reset de senha enviadas para o seu e-mail.', 'success'); }
        }
        
        function validarForcaSenha(senha){
            if(senha.length < 8) return "A senha deve ter no mínimo 8 caracteres";
            if(!/[A-Z]/.test(senha)) return "A senha deve conter pelo menos uma letra maiúscula";
            if(!/[!@#$%^&*(),.?":{}|<>]/.test(senha)) return "A senha deve conter pelo menos um caractere especial";
            return null;
        }

        // Salva a nova senha no primeiro acesso (Troca de senha obrigatória)
        async function salvarNovaSenha() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confSenha = document.getElementById('confSenha').value;

            if(!novaSenha || novaSenha!==confSenha){ Swal.fire('Erro','As senhas não conferem','error'); return; }
            const msgErro = validarForcaSenha(novaSenha);
            if(msgErro){ Swal.fire('Erro', msgErro, 'error'); return; }

            blockScreen();

            const { error: authError } = await supabaseClient.auth.updateUser({ password: novaSenha });
            if (authError) { unblockScreen(); Swal.fire('Erro','Falha ao atualizar senha no Auth: ' + authError.message,'error'); return; }

            const { error: perfilError } = await supabaseClient.from(TABLE_NAME).update({ primeiro_acesso: false }).eq('id', perfilUsuario.id);
            unblockScreen();
            
            if (perfilError) {
                Swal.fire('Atenção', 'Senha atualizada, mas falha ao marcar o primeiro acesso no perfil.','warning').then(() => { handleLogout(true); });
            } else {
                // Vai direto para o login sem mensagem intermediária
                await Swal.fire('Sucesso','Senha atualizada! Faça login com a nova senha.','success');
                handleLogout(false);
            }
        }
        
        // Lógica de atualização de senha após o link de recuperação (com token)
        async function handlePasswordUpdate() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confSenha = document.getElementById('confSenha').value;
            const btnSalvar = document.getElementById('btnSalvarSenha');

            if(!novaSenha || novaSenha!==confSenha){ Swal.fire('Erro','As senhas não conferem','error'); return; }
            const msgErro = validarForcaSenha(novaSenha);
            if(msgErro){ Swal.fire('Erro', msgErro, 'error'); return; }

            blockScreen();
            btnSalvar.disabled = true;

            const { error } = await supabaseClient.auth.updateUser({ password: novaSenha });
            
            unblockScreen();
            btnSalvar.disabled = false;

            if (error) {
                Swal.fire('Erro ao Atualizar', 'Falha ao atualizar a senha: ' + error.message, 'error');
            } else {
                // Vai direto para o login sem mensagem intermediária
                await Swal.fire('Sucesso!', 'Sua senha foi atualizada. Faça login.', 'success');
                
                window.history.replaceState({}, document.title, window.location.pathname);
                renderLogin();
            }
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO DE TELA ---

        function renderLogin() {
            mainContainer.innerHTML = `
                <div class="login-container" id="login-container">
                    <div class="login-card">
                        <h4>SIGMA</h4>
                        <div class="subtitulo">Gestão Inteligente</div>
                        
                        <div class="mb-3 mt-3">
                            <label for="idUsu" class="form-label">E-mail:</label>
                            <input type="email" id="idUsu" class="form-control" placeholder="Digite seu E-mail" required>
                        </div>

                        <div class="mb-3" id="senhaUsuContainer">
                            <label for="senhaUsu" class="form-label">Senha:</label>
                            <input type="password" id="senhaUsu" class="form-control" placeholder="Digite sua senha" required>
                        </div>

                        <div class="mb-3" id="novaSenhaDiv" style="display:none;">
                            <label for="novaSenha" class="form-label">Nova Senha:</label>
                            <input type="password" id="novaSenha" class="form-control" placeholder="Mínimo 8 caracteres, com maiúscula e especial">
                        </div>

                        <div class="mb-3" id="confSenhaDiv" style="display:none;">
                            <label for="confSenha" class="form-label">Confirme a Senha:</label>
                            <input type="password" id="confSenha" class="form-control" placeholder="Confirme a nova senha">
                        </div>
                        <button class="btn btn-primary w-100" id="btnLogin" onclick="handleLogin()">Entrar</button>
                        <button class="btn btn-success w-100" id="btnSalvarSenha" style="display:none;" onclick="salvarNovaSenha()">Salvar Senha</button>

                        <p id="login-feedback" class="text-danger text-center mt-2" style="display:none;"></p>

                        <div class="text-center mt-2">
                            <a href="javascript:void(0);" id="linkEsqueciSenha" onclick="handlePasswordReset()">Esqueci minha senha</a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Função para alterar senha no primeiro acesso
        function showChangePasswordForm(perfil) {
            // Esconde o container Senha/Label
            document.getElementById('senhaUsuContainer').style.display='none';
            
            document.getElementById('novaSenhaDiv').style.display='block';
            document.getElementById('confSenhaDiv').style.display='block';
            document.getElementById('btnSalvarSenha').style.display='block';
            document.getElementById('btnLogin').style.display='none';
            document.getElementById('linkEsqueciSenha').style.display='none';
            document.getElementById('login-feedback').textContent = `Defina uma nova senha.`;
            document.getElementById('login-feedback').style.display = 'block';
            document.getElementById('btnSalvarSenha').onclick = salvarNovaSenha; 
            
            // Bloqueia o campo e-mail
            document.getElementById('idUsu').disabled = true; 
        }

        // Função para renderizar formulário de alteração de senha após clique no e-mail (Token)
        function renderChangePasswordForm(message = "Defina sua nova senha.", emailParaPreencher = "") {
            renderLogin(); // Renderiza o HTML base do login
            
            // Esconde o container Senha/Label
            document.getElementById('senhaUsuContainer').style.display='none';
            
            // Exibe os campos de nova senha
            document.getElementById('novaSenhaDiv').style.display='block';
            document.getElementById('confSenhaDiv').style.display='block';
            
            // Preenche e desabilita o campo de E-mail
            const emailInput = document.getElementById('idUsu');
            emailInput.value = emailParaPreencher;
            emailInput.disabled = true; // Garante o campo bloqueado

            // Altera o botão de login para o botão de salvar a nova senha
            document.getElementById('btnLogin').style.display='none';
            const btnSalvar = document.getElementById('btnSalvarSenha');
            btnSalvar.style.display='block';
            btnSalvar.onclick = handlePasswordUpdate; // Conecta a função de recuperação de senha

            document.getElementById('linkEsqueciSenha').style.display='none';
            document.getElementById('login-feedback').textContent = message;
            document.getElementById('login-feedback').style.display = 'block';
            document.getElementById('login-feedback').classList.remove('text-danger');
            document.getElementById('login-feedback').classList.add('text-success');
        }

        function toggleSidebar(){
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                document.querySelectorAll('.submenu').forEach(sm => sm.style.display = "none");
            }
        }

        function handleMenuClick(submenuId) {
            const sidebar = document.getElementById('sidebar');
            const submenu = document.getElementById(submenuId);

            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                submenu.style.display = "block";
            } else {
                submenu.style.display = (submenu.style.display === "none") ? "block" : "none";
            }
        }

        async function loadPage(pageName) {
            const content = document.getElementById('page-content');
            const topbarTitle = document.getElementById('topbar-title');
            
            if (topbarTitle) { topbarTitle.innerHTML = `${pageName}`; }

            blockScreen();

            if (pageName === 'Usuários') {
                try {
                    // BUSCA O HTML EXTERNO (MÓDULO DE CRUD)
                    const pageContentHTML = `
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="card shadow mb-4" id="formCard">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0" id="formTitle">Novo Usuário</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="userForm">
                                            <input type="hidden" id="idUsr">
                                            
                                            <div class="mb-3">
                                                <label for="nomeUsr" class="form-label">Nome:</label>
                                                <input type="text" id="nomeUsr" class="form-control" required>
                                            </div>

                                            <div class="mb-3">
                                                <label for="emailUsr" class="form-label">E-mail (Login):</label>
                                                <input type="email" id="emailUsr" class="form-control" required>
                                            </div>

                                            <div class="mb-3">
                                                <label for="nivelUsr" class="form-label">Nível de Acesso:</label>
                                                <select id="nivelUsr" class="form-select" required>
                                                    <option value="Administrador">Administrador</option>
                                                    <option value="Supervisor">Supervisor</option>
                                                    <option value="Padrao" selected>Padrão</option>
                                                </select>
                                            </div>

                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="statusUsr" checked>
                                                <label class="form-check-label" for="statusUsr">Ativo (Permitir Login)</label>
                                            </div>

                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="primeiroAcessoUsr" checked>
                                                <label class="form-check-label" for="primeiroAcessoUsr">Forçar Troca de Senha (1º Acesso)</label>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <button type="button" id="btnSave" class="btn btn-success">Salvar</button>
                                                <button type="button" id="btnCancel" class="btn btn-secondary">Cancelar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-8">
                                <div class="card shadow mb-4">
                                    <div class="card-header bg-secondary text-white">
                                        <h5 class="mb-0">Lista de Usuários</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-container">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Nome</th>
                                                        <th>E-mail</th>
                                                        <th>Nível</th>
                                                        <th>Status</th>
                                                        <th>1º Acesso</th>
                                                        <th>Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="userTableBody">
                                                    </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    
                    content.innerHTML = pageContentHTML;
                    
                    // Inicializa a lógica do CRUD
                    initializeCrudListeners();
                    resetForm();
                    await loadUsersTable();

                } catch (error) {
                    content.innerHTML = `<h3>Erro de Carregamento</h3><div class="alert alert-danger">Não foi possível carregar o conteúdo da página de Usuários: **${error.message}**. Verifique se o arquivo \`crud-usuarios.html\` existe.</div>`;
                    console.error("Erro ao carregar página de usuários:", error);
                }

            } else if (pageName === 'Dashboard') {
                content.innerHTML = `<h3>Dashboard</h3><div class="alert alert-info">Bem-vindo(a), **${perfilUsuario.nome_usu}**! Clique nos links do menu lateral para navegar!</div>`;
            } else {
                content.innerHTML = `<h3>${pageName}</h3><div class="alert alert-warning">Este módulo está em desenvolvimento.</div>`;
            }

            unblockScreen();
        }
        
        function renderMainPage(perfil) {
            const sessaoIdCurto = perfil.sessao_atual ? perfil.sessao_atual.substring(0, 8) : 'N/A';
            
            mainContainer.innerHTML = `
                <div class="main-wrapper" id="main-wrapper">
                    <div class="sidebar collapsed" id="sidebar">
                        <div class="menu-items">
                            <a href="javascript:void(0);" class="toggle-btn" onclick="toggleSidebar()">
                                <span class="icon">menu</span>
                                <span class="text">SIGMA</span>
                            </a>
                            <hr>

                            <div class="user-profile" id="user-profile-info">
                                <div class="user-greeting">Bem-vindo(a),</div>
                                <div class="user-name">${perfil.nome_usu || 'Usuário'}</div>
                            </div>
                            <hr>

                            <a href="#" onclick="loadPage('Dashboard')"><span class="icon">home</span><span class="text">Dashboard</span></a>

                            <div class="menu-item">
                                <a href="#" onclick="handleMenuClick('cadastrosSub')">
                                    <span class="icon">engineering</span>
                                    <span class="text">Cadastros</span>
                                    <span class="icon expand-icon" style="margin-left:auto;">expand_more</span>
                                </a>
                                <div class="submenu" id="cadastrosSub" style="display:none;">
                                    <a href="#" onclick="loadPage('Obras')"><span class="icon">format_list_bulleted</span><span class="text">Obras</span></a>
                                    
                                    <a href="#" onclick="loadPage('Usuários')"><span class="icon">person</span><span class="text">Usuários</span></a>
                                    
                                    <a href="#" onclick="loadPage('Departamentos')"><span class="icon">groups</span><span class="text">Departamentos</span></a>
                                </div>
                            </div>
                            
                            <a href="#" onclick="loadPage('Relatórios')"><span class="icon">bar_chart</span><span class="text">Relatórios</span></a>
                        </div>

                        <div class="logout-area">
                            <a href="#" onclick="handleLogout()">
                            <span class="icon">logout</span><span class="text">Sair</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="content-wrapper">
                        <div class="topbar" id="topbar-title">Menu Principal</div>
                        <div class="content" id="page-content">
                        </div>
                        <div class="footer">
                            <span>SIGMA - Sistema Inteligente de Gestão &copy; 2025</span>
                            <span id="nivel-usuario">Perfil: ${perfil.nivel_usu || 'Padrão'} | Sessão ID: ${sessaoIdCurto}</span>
                        </div>
                    </div>
                </div>
            `;
            loadPage('Dashboard');
        }

        // --- LÓGICA DE INICIALIZAÇÃO E CHECAGEM DE URL ---

        async function checkURLForPasswordReset() {
            const hash = window.location.hash;
            const urlParams = new URLSearchParams(hash.substring(1));
            const type = urlParams.get('type');
            const accessToken = urlParams.get('access_token');
            
            if (type === 'recovery' && accessToken) {
                blockScreen();
                
                // 1. Tenta usar o token para obter a sessão
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError || !session) {
                    unblockScreen();
                    // Limpa o URL e vai para o login com erro
                    window.history.replaceState({}, document.title, window.location.pathname);
                    Swal.fire('Erro de Token', 'O link de recuperação expirou ou é inválido.', 'error');
                    renderLogin();
                    return true; 
                }
                
                // 2. EXTRAI O EMAIL DO OBJETO DE SESSÃO DO SUPABASE
                const userEmail = session.user.email;

                unblockScreen();
                
                // 3. Mostra o formulário de mudança de senha com o e-mail preenchido e desabilitado
                renderChangePasswordForm("Defina uma nova senha.", userEmail);
                return true; 
            }
            return false; 
        }

        async function initApp() {
            blockScreen();
            
            // 1. Prioridade: Redefinição de Senha
            const isResetFlow = await checkURLForPasswordReset();
            if (isResetFlow) {
                unblockScreen();
                return;
            }

            // 2. Segunda Prioridade: Sessão Ativa
            // Usa o sessionStorage (limpa ao fechar o navegador)
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                const userId = session.user.id;
                const { data: perfil, error: perfilError } = await supabaseClient
                    .from(TABLE_NAME)
                    .select(`id, nome_usu, nivel_usu, sessao_atual`)
                    .eq('id', userId)
                    .single();

                if (perfil && !perfilError) {
                    perfilUsuario = perfil;
                    renderMainPage(perfilUsuario);
                    unblockScreen();
                    return;
                } else {
                    // Se o perfil falhar, faz logout e vai para o login
                    await supabaseClient.auth.signOut();
                }
            } else {
                // Sem sessão encontrada, garante o logout (limpeza de token antigo do localStorage)
                await supabaseClient.auth.signOut();
            }
            
            // 3. Padrão: Tela de Login
            renderLogin();
            unblockScreen();
        }

        // INICIA O APLICATIVO
        initApp();
    </script>
</body>
</html>
