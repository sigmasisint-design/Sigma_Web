<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%231565C0%22><path d=%22M11 20v-5h-4l6-11v5h4l-6 11z%22/><text x=%2222%22 y=%2220%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%231565C0%22>Σ</text></svg>">
    <title>SIGMA - Gestão Inteligente</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet" /> 
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>
<body>
    <div id="main-container"></div>
    <div id="screen-blocker"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // *** CERTIFIQUE-SE DE INSERIR SUAS CHAVES AQUI ***
        const SUPABASE_URL = 'https://nxgccbvfcxbukhciknoo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54Z2NjYnZmY3hidWtoY2lrbm9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyODkzMDAsImV4cCI6MjA3Mzg2NTMwMH0.8iTGv8HzocnJBXB9xT5VUNbwidceKIIbZDuwhGKnahk';
        const TABLE_NAME = 'perfis';
        // **********************************************

        // **** CONFIGURAÇÃO CRÍTICA: USANDO SESSIONSTORAGE ****
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storageKey: 'supabase.auth.session', 
                storage: window.sessionStorage,       
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });
        // *************************************************

        
        let perfilUsuario = null;
        let sessaoIDAtual = null;
        let currentEditingUser = null;

        const mainContainer = document.getElementById("main-container");
        const screenBlocker = document.getElementById('screen-blocker');

        function blockScreen() { screenBlocker.style.display='block'; }
        function unblockScreen() { screenBlocker.style.display='none'; }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // --- FUNÇÕES DE CRUD ---
        
        function resetForm(clearOnly = false) {
            const form = document.getElementById('formCadastroUsuario');
            if (!form) return;
            
            form.reset();
            currentEditingUser = null;
            document.getElementById('cadUserId').value = "";
            document.getElementById('form-title').textContent = "Novo Usuário";
            document.getElementById('cadastro-feedback').style.display = 'none';

            const senhaField = document.getElementById('senha-field');
            if (senhaField) senhaField.style.display = 'block';
            document.getElementById('cadSenha').required = true;
            document.getElementById('cadSenha').placeholder = "Mínimo 8 caracteres";
            
            document.getElementById('cadEmail').disabled = false;
            document.getElementById('cadEmail').placeholder = "Será usado para login";
            document.getElementById('cadEmail').required = true;
            
            document.getElementById('btnSalvarUsuario').innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px; margin-right: 5px; vertical-align: middle;">person_add</span> Cadastrar Usuário';
            document.getElementById('btnLimparForm').style.display = 'none';
            
            if (clearOnly) {
                Swal.fire('Novo Cadastro', 'Formulário pronto para um novo usuário.', 'info');
            }
        }
        
        function initializeCrudListeners() {
            const formCadastro = document.getElementById('formCadastroUsuario');
            if (formCadastro) {
                formCadastro.removeEventListener('submit', handleCadastroUsuario);
                formCadastro.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleCadastroUsuario();
                });
            }
            
            const cadCpfInput = document.getElementById('cadCPF');
            if (cadCpfInput) {
                cadCpfInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
            
            const btnLimpar = document.getElementById('btnLimparForm');
            if (btnLimpar) {
                btnLimpar.addEventListener('click', function() {
                    resetForm(true);
                });
            }
        }
        
        async function loadUsersTable() {
            const tableBody = document.getElementById('users-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando usuários...</td></tr>';
            
            const { data: users, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('id, nome_usu, nivel_usu, matricula_usu, cpf_usu')
                .order('nome_usu', { ascending: true });

            if (error) {
                console.error('Erro ao carregar usuários:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Falha ao carregar usuários. Verifique as permissões (RLS) da tabela perfis.</td></tr>';
                return;
            }
            
            if (!users || users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum usuário cadastrado.</td></tr>';
                return;
            }

            let html = '';
            users.forEach(user => {
                const isCurrentUser = perfilUsuario && user.id === perfilUsuario.id;
                const emailDisplay = "---";

                html += `
                    <tr>
                        <td>${user.nome_usu}</td>
                        <td>${user.nivel_usu}</td>
                        <td>${user.matricula_usu}</td>
                        <td>${emailDisplay}</td>
                        <td>
                            <button class="btn btn-sm btn-info btn-acao me-1" onclick="handleEditUser('${user.id}')" title="Editar">
                                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">edit</span>
                            </button>
                            ${isCurrentUser
                                ? `<button class="btn btn-sm btn-danger btn-acao" disabled title="Você não pode excluir a si mesmo">
                                    <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">delete</span>
                                </button>`
                                : `<button class="btn btn-sm btn-danger btn-acao" onclick="handleDeleteUser('${user.id}', '${user.nome_usu}')" title="Excluir">
                                    <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">delete</span>
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        async function handleEditUser(userId) {
            blockScreen();
            resetForm();
            
            const { data: user, error } = await supabaseClient
                .from(TABLE_NAME)
                .select(`*, auth:auth.users(email)`)
                .eq('id', userId)
                .single();

            unblockScreen();
            
            if (error || !user) {
                Swal.fire('Erro', 'Não foi possível carregar os dados do usuário para edição.', 'error');
                return;
            }
            
            currentEditingUser = userId;
            document.getElementById('cadUserId').value = userId;
            document.getElementById('form-title').textContent = `Editar Usuário: ${user.nome_usu}`;
            
            document.getElementById('cadNome').value = user.nome_usu;
            document.getElementById('cadNivel').value = user.nivel_usu;
            document.getElementById('cadEmpresa').value = user.empresa_usu;
            document.getElementById('cadMatricula').value = user.matricula_usu;
            document.getElementById('cadCPF').value = user.cpf_usu;
            
            const userEmail = user.auth && user.auth.length > 0 ? user.auth[0].email : "E-mail indisponível";
            
            document.getElementById('cadEmail').value = userEmail;
            document.getElementById('cadEmail').disabled = true;
            document.getElementById('cadEmail').required = false;
            
            const senhaField = document.getElementById('senha-field');
            if (senhaField) senhaField.style.display = 'none';
            document.getElementById('cadSenha').required = false;

            document.getElementById('btnSalvarUsuario').innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px; margin-right: 5px; vertical-align: middle;">update</span> Salvar Alterações';
            document.getElementById('btnLimparForm').style.display = 'inline-block';

            Swal.fire('Modo Edição', `Carregando dados de ${user.nome_usu}. E-mail e Senha não podem ser alterados nesta tela.`, 'info');
        }

        async function handleDeleteUser(userId, userName) {
            const result = await Swal.fire({
                title: `Tem certeza que deseja excluir ${userName}?`,
                text: "Esta ação é irreversível e removerá o perfil e o acesso de login.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, Excluir!',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                blockScreen();
                
                const { error: authError } = await supabaseClient.auth.admin.deleteUser(userId);
                
                const { error: perfilError } = await supabaseClient
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', userId);
                
                unblockScreen();
                
                if (perfilError) {
                    Swal.fire('Erro RLS/Exclusão', `Falha ao excluir o perfil: ${perfilError.message}.`, 'error');
                    return;
                }

                if (authError && authError.message.includes('not allowed')) {
                    Swal.fire('Aviso de Segurança', `Perfil excluído. Mas a conta de Auth não pôde ser excluída (permissão negada).`, 'warning');
                } else if (authError) {
                    Swal.fire('Aviso', `Perfil excluído. Erro no Auth: ${authError.message}`, 'warning');
                } else {
                    Swal.fire('Excluído!', `O usuário ${userName} foi removido PERMANENTEMENTE.`, 'success');
                }
                
                loadUsersTable();
            }
        }

        async function handleCadastroUsuario() {
            const userId = document.getElementById('cadUserId').value;
            const isEditing = !!userId;
            
            const matricula = document.getElementById('cadMatricula').value.trim();
            const empresa = document.getElementById('cadEmpresa').value.trim();
            const cpf = document.getElementById('cadCPF').value.trim();
            const nome = document.getElementById('cadNome').value.trim();
            const nivel = document.getElementById('cadNivel').value;
            const email = isEditing ? null : document.getElementById('cadEmail').value.trim();
            const senha = isEditing ? null : document.getElementById('cadSenha').value;
            
            const feedback = document.getElementById('cadastro-feedback');
            // Usando 'SYSTEM' como fallback para fins de auditoria interna
            const nomeUsuarioLogado = perfilUsuario ? perfilUsuario.nome_usu : 'SYSTEM'; 
            const dataHoraAtual = new Date().toISOString();

            feedback.style.display = 'none';

            if (!nome || !nivel || !matricula || !empresa || cpf.length !== 11) {
                feedback.textContent = "Preencha Nome, Nível, Matrícula, Empresa, e CPF (11 dígitos).";
                feedback.style.display = 'block';
                return;
            }
            if (!isEditing && (!email || !senha || senha.length < 8)) {
                feedback.textContent = "Para novo cadastro, E-mail é obrigatório e Senha deve ter no mínimo 8 caracteres.";
                feedback.style.display = 'block';
                return;
            }

            blockScreen();

            if (isEditing) {
                const { error: perfilError } = await supabaseClient
                    .from(TABLE_NAME)
                    .update({
                        matricula_usu: matricula, empresa_usu: empresa, cpf_usu: cpf,
                        nome_usu: nome, nivel_usu: nivel,
                        data_alt: dataHoraAtual, usu_alt: nomeUsuarioLogado,
                    })
                    .eq('id', userId);

                unblockScreen();
                if (perfilError) {
                    Swal.fire('Erro na Edição', `Falha ao atualizar o perfil: ${perfilError.message}.`, 'error');
                    return;
                }
                Swal.fire('Sucesso!', `O usuário **${nome}** foi atualizado.`, 'success');
                resetForm();
                loadUsersTable();
                
            } else {
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: senha,
                });
                
                if (authError) {
                    unblockScreen();
                    const msg = authError.message.includes('already registered') ? 'Este e-mail já está cadastrado.' : authError.message;
                    Swal.fire('Erro no Cadastro', msg, 'error');
                    return;
                }

                const newUserId = authData.user.id;
                
                const { error: perfilError } = await supabaseClient
                    .from(TABLE_NAME)
                    .insert({
                        id: newUserId,
                        matricula_usu: matricula, empresa_usu: empresa, cpf_usu: cpf,
                        nome_usu: nome, nivel_usu: nivel,
                        data_alt: dataHoraAtual, usu_alt: nomeUsuarioLogado,
                        primeiro_acesso: true, bloqueado: false, cont_erro_login: 0, sessao_atual: null,
                    });

                unblockScreen();
                if (perfilError) {
                    await supabaseClient.auth.admin.deleteUser(newUserId);
                    Swal.fire({
                        title: 'Aviso Crítico',
                        html: `Usuário criado no Auth, mas **falha ao criar o perfil**: ${perfilError.message}. Contate o suporte para limpeza do registro.`,
                        icon: 'warning'
                    });
                    return;
                }

                Swal.fire({
                    title: 'Sucesso!',
                    html: `O usuário **${nome}** foi cadastrado com sucesso e deve definir a senha no primeiro acesso.`,
                    icon: 'success'
                });
                resetForm();
                loadUsersTable();
            }
        }
        
        // --- FUNÇÕES DE LOGIN E SEGURANÇA ---
        
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const senha = document.getElementById('loginSenha').value;
            const feedback = document.getElementById('login-feedback');
            
            if (!email || !senha) {
                feedback.textContent = "Preencha e-mail e senha.";
                feedback.style.display = 'block';
                return;
            }

            feedback.style.display = 'none';
            blockScreen();

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: senha });
            
            if (error) {
                unblockScreen();
                feedback.textContent = error.message.includes('Invalid login') ? 'E-mail ou senha incorretos.' : error.message;
                feedback.style.display = 'block';
                return;
            }

            const userId = data.user.id;
            
            // 1. Verificar perfil
            const { data: perfilData, error: perfilError } = await supabaseClient
                .from(TABLE_NAME)
                .select('*')
                .eq('id', userId)
                .single();

            if (perfilError || !perfilData) {
                unblockScreen();
                Swal.fire('Erro de Perfil', 'O perfil do usuário não foi encontrado ou está desativado.', 'error');
                await supabaseClient.auth.signOut();
                return;
            }

            if (perfilData.bloqueado) {
                unblockScreen();
                Swal.fire('Acesso Negado', 'Sua conta está bloqueada. Contate o administrador.', 'error');
                await supabaseClient.auth.signOut();
                return;
            }
            
            // 2. Definir nova sessão (UUID)
            const novaSessaoID = generateUUID();
            
            // 3. Atualizar sessão e contador de erros no banco
            const { error: updateError } = await supabaseClient
                .from(TABLE_NAME)
                .update({ 
                    sessao_atual: novaSessaoID, 
                    cont_erro_login: 0 
                })
                .eq('id', userId);

            unblockScreen();

            if (updateError) {
                Swal.fire('Erro Interno', 'Falha ao registrar a sessão no banco.', 'error');
                await supabaseClient.auth.signOut();
                return;
            }
            
            perfilUsuario = perfilData;
            sessaoIDAtual = novaSessaoID;
            
            if (perfilData.primeiro_acesso) {
                showChangePasswordForm(userId, perfilData.nome_usu, true);
            } else {
                renderMainPage();
            }
        }
        
        function showChangePasswordForm(userId, userName, isFirstLogin) {
            renderChangePasswordForm(isFirstLogin);
            
            const formTitle = isFirstLogin ? 'Primeiro Acesso: Nova Senha' : 'Atualizar Senha';
            document.getElementById('change-password-title').textContent = formTitle;
            document.getElementById('changeUserId').value = userId;
            document.getElementById('changeUserName').textContent = userName;
            
            // Esconde o botão de voltar/logout
            document.getElementById('btnBackToLogin').style.display = isFirstLogin ? 'none' : 'inline-block';
            document.getElementById('btnChangePassword').disabled = false;
        }

        async function handleLogout() {
            const result = await Swal.fire({
                title: 'Tem certeza?',
                text: "Você será desconectado do sistema.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sim, Sair!',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                blockScreen();
                
                if (perfilUsuario) {
                    await supabaseClient
                        .from(TABLE_NAME)
                        .update({ sessao_atual: null })
                        .eq('id', perfilUsuario.id);
                }
                
                await supabaseClient.auth.signOut();
                
                perfilUsuario = null;
                sessaoIDAtual = null;
                
                unblockScreen();
                renderLogin();
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                Swal.fire('Aviso', 'Por favor, digite seu e-mail no campo de login.', 'warning');
                return;
            }

            blockScreen();

            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + window.location.pathname + '?action=reset'
            });
            
            unblockScreen();

            if (error) {
                Swal.fire('Erro', `Falha ao enviar e-mail: ${error.message}`, 'error');
            } else {
                Swal.fire('E-mail Enviado', `Verifique a caixa de entrada de **${email}** para redefinir sua senha.`, 'success');
            }
        }
        
        function validarForcaSenha(senha) {
            if (senha.length < 8) return "A senha deve ter no mínimo 8 caracteres.";
            if (!/[A-Z]/.test(senha)) return "A senha deve conter pelo menos uma letra maiúscula.";
            if (!/[a-z]/.test(senha)) return "A senha deve conter pelo menos uma letra minúscula.";
            if (!/[0-9]/.test(senha)) return "A senha deve conter pelo menos um número.";
            if (!/[^A-Za-z0-9]/.test(senha)) return "A senha deve conter pelo menos um caractere especial.";
            return null; // Senha forte
        }

        async function salvarNovaSenha(e) {
            e.preventDefault();
            const userId = document.getElementById('changeUserId').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const feedback = document.getElementById('password-feedback');
            const isFirstLogin = document.getElementById('btnBackToLogin').style.display === 'none';

            feedback.style.display = 'none';

            if (newPassword !== confirmPassword) {
                feedback.textContent = "As senhas não coincidem.";
                feedback.style.display = 'block';
                return;
            }

            const forcaErro = validarForcaSenha(newPassword);
            if (forcaErro) {
                feedback.textContent = forcaErro;
                feedback.style.display = 'block';
                return;
            }

            blockScreen();

            const { error: authError } = await supabaseClient.auth.updateUser({
                password: newPassword
            });

            if (authError) {
                unblockScreen();
                feedback.textContent = `Erro ao atualizar senha: ${authError.message}`;
                feedback.style.display = 'block';
                return;
            }

            // Se for o primeiro acesso, atualizar o flag
            if (isFirstLogin) {
                const { error: perfilError } = await supabaseClient
                    .from(TABLE_NAME)
                    .update({ primeiro_acesso: false })
                    .eq('id', userId);
                    
                if (perfilError) {
                    // Este erro não impede o login, mas deve ser logado.
                    console.error("Falha ao remover flag de primeiro acesso:", perfilError);
                }
            }

            unblockScreen();
            
            // Força o logout e redireciona para o login (necessário para redefinir o estado da sessão)
            await supabaseClient.auth.signOut();
            Swal.fire({
                title: 'Sucesso!',
                text: 'Sua senha foi atualizada. Faça login novamente com a nova senha.',
                icon: 'success',
                allowOutsideClick: false
            }).then(() => {
                window.location.href = window.location.origin + window.location.pathname; // Redireciona para o index limpo
            });
        }
        
        async function handlePasswordUpdate(e) {
            await salvarNovaSenha(e);
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO DE TELA ---
        
        function renderLogin() {
            mainContainer.innerHTML = `
                <div class="login-container">
                    <div class="login-card">
                        <h4 class="mb-1">SIGMA</h4>
                        <p class="subtitulo mb-4">Gestão Inteligente</p>
                        <form id="loginForm" onsubmit="event.preventDefault(); handleLogin();">
                            <div class="mb-3">
                                <label for="loginEmail" class="form-label">E-mail (Login):</label>
                                <input type="email" id="loginEmail" class="form-control" required autocomplete="username">
                            </div>
                            <div class="mb-3">
                                <label for="loginSenha" class="form-label">Senha:</label>
                                <input type="password" id="loginSenha" class="form-control" required autocomplete="current-password">
                            </div>
                            <p id="login-feedback" class="text-danger mt-2" style="display:none;"></p>
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 5px; vertical-align: middle;">login</span>
                                    ENTRAR
                                </button>
                            </div>
                            <div class="text-center mt-3">
                                <a href="#" id="linkEsqueciSenha" onclick="handlePasswordReset()">Esqueci minha senha</a>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('loginEmail').focus();
        }

        function renderChangePasswordForm(isFirstLogin) {
            mainContainer.innerHTML = `
                <div class="login-container">
                    <div class="login-card" style="max-width: 450px;">
                        <h4 class="mb-1" id="change-password-title">Primeiro Acesso: Nova Senha</h4>
                        <p class="subtitulo mb-3">Usuário: <span id="changeUserName" class="text-dark"></span></p>
                        <p class="text-center" style="font-size: 0.85rem;">Defina uma senha forte para continuar.</p>
                        <form id="changePasswordForm" onsubmit="handlePasswordUpdate(event)">
                            <input type="hidden" id="changeUserId">
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">Nova Senha:</label>
                                <input type="password" id="newPassword" class="form-control" required autocomplete="new-password">
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirmar Nova Senha:</label>
                                <input type="password" id="confirmPassword" class="form-control" required autocomplete="new-password">
                            </div>
                            <p id="password-feedback" class="text-danger mt-2" style="display:none;"></p>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" id="btnBackToLogin" class="btn btn-secondary" style="display: ${isFirstLogin ? 'none' : 'inline-block'};" onclick="handleLogout()">
                                    Voltar
                                </button>
                                <button type="submit" id="btnChangePassword" class="btn btn-success ms-auto">
                                    <span class="material-symbols-outlined" style="font-size: 18px; margin-right: 5px; vertical-align: middle;">save</span>
                                    Salvar Senha
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggle-icon');
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.textContent = 'chevron_right';
            } else {
                toggleIcon.textContent = 'chevron_left';
            }
        }
        
        function handleMenuClick(pageName) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', pageName);
            window.history.pushState({ page: pageName }, '', url.toString());
            loadPage(pageName);
        }

        function renderMainPage() {
            mainContainer.innerHTML = `
                <div class="main-wrapper">
                    <div id="sidebar" class="sidebar">
                        <div class="user-profile text-center">
                            <p class="user-greeting">Bem-vindo(a),</p>
                            <p class="user-name" id="userNameDisplay">${perfilUsuario.nome_usu}</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center" style="padding: 0 5px 5px 5px;">
                            <div class="d-flex align-items-center">
                                <span class="material-symbols-outlined icon">verified_user</span>
                                <span class="text" style="font-size: 0.8rem; margin-top: 2px;">${perfilUsuario.nivel_usu}</span>
                            </div>
                            <a href="#" onclick="toggleSidebar(); return false;" class="text-white" style="padding: 0 5px;">
                                <span id="toggle-icon" class="material-symbols-outlined">chevron_left</span>
                            </a>
                        </div>
                        <hr>
                        <div class="menu-items">
                            <a href="#" onclick="handleMenuClick('Dashboard'); return false;">
                                <span class="material-symbols-outlined icon">dashboard</span>
                                <span class="text">Dashboard</span>
                            </a>
                            <a href="#" onclick="handleMenuClick('Operação'); return false;">
                                <span class="material-symbols-outlined icon">work</span>
                                <span class="text">Operação</span>
                            </a>
                            <a href="#" onclick="handleMenuClick('Relatórios'); return false;">
                                <span class="material-symbols-outlined icon">analytics</span>
                                <span class="text">Relatórios</span>
                            </a>
                            
                            <hr style="margin-top: 10px;">
                            
                            ${perfilUsuario.nivel_usu === 'Administrador' ? `
                                <a href="#" onclick="handleMenuClick('Configurações'); return false;">
                                    <span class="material-symbols-outlined icon">settings</span>
                                    <span class="text">Configurações</span>
                                </a>
                                <a href="#" onclick="handleMenuClick('Usuários'); return false;">
                                    <span class="material-symbols-outlined icon">group</span>
                                    <span class="text">Gerenciar Usuários</span>
                                </a>
                            ` : ''}

                            <hr style="margin-top: 10px;">

                            <a href="#" onclick="showChangePasswordForm('${perfilUsuario.id}', '${perfilUsuario.nome_usu}', false); return false;">
                                <span class="material-symbols-outlined icon">lock</span>
                                <span class="text">Mudar Senha</span>
                            </a>
                        </div>

                        <div class="logout-area">
                            <a href="#" onclick="handleLogout(); return false;">
                                <span class="material-symbols-outlined icon">logout</span>
                                <span class="text">Sair</span>
                            </a>
                        </div>
                    </div>

                    <div class="content-wrapper">
                        <div class="topbar">
                            <span id="topbar-title">Dashboard</span>
                        </div>
                        <div id="page-content" class="content">
                            </div>
                        <div class="footer">
                            <span>SIGMA © 2024</span>
                            <span>v1.0</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Carrega a página inicial ou a página da URL
            const urlParams = new URLSearchParams(window.location.search);
            const page = urlParams.get('page') || 'Dashboard';
            loadPage(page);
        }

        async function loadPage(pageName) {
            const content = document.getElementById('page-content');
            const topbarTitle = document.getElementById('topbar-title');
            
            if (topbarTitle) { topbarTitle.innerHTML = `${pageName}`; }

            blockScreen();

            if (pageName === 'Usuários') {
                try {
                    // BUSCA O HTML EXTERNO
                    const response = await fetch('crud-usuarios.html'); 
                    if (!response.ok) {
                        throw new Error(`Erro ao carregar o arquivo: ${response.statusText}`);
                    }
                    const pageContentHTML = await response.text();
                    content.innerHTML = pageContentHTML;
                    
                    // Inicializa a lógica do CRUD
                    initializeCrudListeners();
                    resetForm();
                    await loadUsersTable();

                } catch (error) {
                    content.innerHTML = `<h3>Erro de Carregamento</h3><div class="alert alert-danger">Não foi possível carregar o conteúdo da página de Usuários: **${error.message}**. Verifique se o arquivo \`crud-usuarios.html\` existe.</div>`;
                    console.error("Erro ao carregar página de usuários:", error);
                }

            } else if (pageName === 'Dashboard') {
                content.innerHTML = `<h3>Dashboard</h3><div class="alert alert-info">Bem-vindo(a), **${perfilUsuario.nome_usu}**! Clique nos links do menu lateral para navegar!</div>`;
            } else {
                content.innerHTML = `<h3>${pageName}</h3><div class="alert alert-warning">Este módulo está em desenvolvimento.</div>`;
            }

            unblockScreen();
        }
        
        // --- LÓGICA DE INICIALIZAÇÃO E CHECAGEM DE URL ---

        async function checkURLForPasswordReset() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'reset') {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    const { data: perfilData, error } = await supabaseClient
                        .from(TABLE_NAME)
                        .select('nome_usu')
                        .eq('id', user.id)
                        .single();
                        
                    if (!error && perfilData) {
                        showChangePasswordForm(user.id, perfilData.nome_usu, false);
                    } else {
                        // Se não encontrar o perfil, força a mudança de senha no Auth
                        showChangePasswordForm(user.id, 'Usuário Desconhecido', false);
                    }
                    return true;
                }
            }
            return false;
        }

        async function initApp() {
            blockScreen();
            
            // 1. Checa se é um reset de senha pela URL
            if (await checkURLForPasswordReset()) {
                unblockScreen();
                return;
            }
            
            // 2. Tenta obter a sessão atual (se houver)
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                const userId = session.user.id;
                
                // 3. Verifica o perfil e a validade da sessão no banco de dados
                const { data: perfilData, error } = await supabaseClient
                    .from(TABLE_NAME)
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (!error && perfilData && perfilData.sessao_atual === session.session_id) {
                    perfilUsuario = perfilData;
                    sessaoIDAtual = session.session_id;
                    renderMainPage();
                } else {
                    // Sessão inválida (ex: ID da sessão diferente no banco ou perfil bloqueado)
                    await supabaseClient.auth.signOut();
                    renderLogin();
                }

            } else {
                // Não há sessão, renderiza o login
                renderLogin();
            }

            unblockScreen();
        }

        // INICIA O APLICATIVO
        initApp();
    </script>
</body>
</html>
